{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ state.name }} - South India Tourism</title>
  <meta name="description" content="Explore the diverse wonders of {{ state.name }}, from ancient temples and beaches to vibrant cities and lush hills.">
  <!-- External CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="{% static 'core/css/style.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
  <!-- Google Maps API (Best Practice Loader) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3WSnlZlux7vVPP2LQ7fZvg8O43J01mK8&callback=initMaps&loading=async" async defer></script>
  <style>
    .btn-loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .hero-section, #apHeroCarousel, .hero-section .carousel-inner, .hero-section .carousel-item, .hero-section img.d-block.w-100 { width: 100vw !important; height: 100vh !important; min-height: 100vh; margin: 0 !important; padding: 0 !important; border: none; box-sizing: border-box; }
    .hero-section { position: relative; overflow: hidden; background: #000; z-index: 1; }
    .hero-section .carousel-item img { object-fit: cover; width: 100vw; height: 100vh; min-height: 100vh; display: block; }
    .hero-section .carousel-caption { bottom: 10vh; }
    .hero-section .hero-overlay { width: 100vw; height: 100vh; min-height: 100vh; left: 0; top: 0; pointer-events: none; z-index: 3; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; }
    .hero-overlay > div { pointer-events: auto; }
    @media (max-width: 768px) {
      .hero-section, #apHeroCarousel, .hero-section .carousel-inner, .hero-section .carousel-item, .hero-section img.d-block.w-100, .hero-section .hero-overlay { width: 100vw !important; height: 60vh !important; min-height: 60vh; }
      .hero-section .carousel-caption { bottom: 2vh; font-size: 1rem; }
    }
    .place-card img { height: 200px; object-fit: cover; border-top-left-radius: 15px; border-top-right-radius: 15px; }
    .map-modal .modal-dialog { max-width: 800px; }
    .place-card { height: 100%; transition: transform 0.2s, box-shadow 0.2s; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 15px; }
    .place-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .place-card .card-body { padding: 1.5rem; }
    .place-card .card-title { font-size: 1.25rem; margin-bottom: 1rem; color: #1a472a; font-weight: 600; }
    .place-card .weather-info { background-color: #f8f9fa; border-radius: 0.5rem; padding: 0.8rem; margin-bottom: 1rem; }
    .place-card .weather-info p { margin-bottom: 0.3rem; font-size: 0.9rem; }
    .place-card .weather-info i { margin-right: 0.5rem; color: #0d6efd; }
    .place-card .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .back-to-top { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background-color: #1a472a; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .back-to-top:hover { background-color: #2d5a3f; color: white; transform: translateY(-3px); }
    .back-to-top.show { opacity: 1; visibility: visible; }
    .back-to-top i { font-size: 20px; }
    .recommendations-header { background: linear-gradient(135deg, #1a472a, #2d5a3f); color: white; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; }
    .recommendations-header h4 { color: white; margin-bottom: 0.5rem; }
    .recommendation-filters { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .filter-card { background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s ease; }
    .filter-card:hover { border-color: #1a472a; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(26, 71, 42, 0.2); }
    .filter-card label { font-weight: 600; color: #1a472a; margin-bottom: 0.5rem; }
    .filter-card .form-select { border: 1px solid #dee2e6; border-radius: 8px; padding: 0.75rem; transition: all 0.3s ease; }
    .filter-card .form-select:focus { border-color: #1a472a; box-shadow: 0 0 0 0.2rem rgba(26, 71, 42, 0.25); }
    .recommendations-container { min-height: 200px; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden; }
    .recommendation-placeholder { padding: 3rem; }
    .recommendation-placeholder i { color: #1a472a; opacity: 0.5; }
    .recommendation-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: all 0.3s ease; border: 2px solid transparent; }
    .recommendation-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-color: #1a472a; }
    .recommendation-card .card-body { padding: 1.5rem; }
    .recommendation-card .card-title { color: #1a472a; font-weight: 600; margin-bottom: 1rem; }
    .recommendation-badge { background: linear-gradient(135deg, #1a472a, #2d5a3f); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; margin-bottom: 1rem; display: inline-block; }
    .recommendation-weather { background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; }
    .recommendation-weather h6 { color: #1976d2; margin-bottom: 0.5rem; }
    .recommendation-actions { display: flex; gap: 0.5rem; margin-top: auto; }
    .recommendation-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; }
    .recommendation-loading .spinner-border { color: #1a472a; width: 3rem; height: 3rem; }
    .interactive-map-section { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
    .map-navigation-card { background: white; border-radius: 20px; padding: 3rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(26, 71, 42, 0.1); transition: all 0.3s ease; }
    .map-navigation-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
    .map-preview { background: linear-gradient(135deg, #1a472a, #2d5a3f); color: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(26, 71, 42, 0.2); transition: all 0.3s ease; }
    .map-preview:hover { transform: scale(1.02); box-shadow: 0 15px 35px rgba(26, 71, 42, 0.3); }
    .map-preview .btn { background: #ffd700; border: none; color: #1a472a; font-weight: 600; padding: 1rem 2rem; border-radius: 25px; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
    .map-preview .btn:hover { background: #ffed4e; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4); color: #1a472a; }
    .trip-planning-section { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
    .trip-tabs .nav-link { border: none; border-radius: 12px; margin-right: 0.5rem; padding: 1rem 1.5rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .trip-tabs .nav-link.active { background: linear-gradient(135deg, #1a472a, #2d5a3f); color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(26, 71, 42, 0.3); }
    .trip-tabs .nav-link:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    .itinerary-builder-card, .reviews-section, .inquiry-card { background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(26, 71, 42, 0.1); }
    .quick-tips-card, .review-stats-card { background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(26, 71, 42, 0.1); height: fit-content; }
    .tip-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 10px; transition: all 0.3s ease; }
    .tip-item:hover { transform: translateX(5px); background: #1a472a; color: white; }
    .tip-item i { font-size: 1.2rem; min-width: 20px; }
    .review-card { background: white; border-radius: 15px; padding: 1.5rem; border: 1px solid #e9ecef; }
    .reviewer-info { display: flex; align-items: center; gap: 1rem; }
    .reviewer-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
    .review-rating { display: flex; gap: 0.25rem; }
    .review-place { color: #1a472a; font-weight: 600; margin-bottom: 0.5rem; }
    .review-comment { color: #6c757d; line-height: 1.6; margin: 0; }
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-item { text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 12px; }
    .stat-number { font-size: 1.5rem; font-weight: 700; color: #1a472a; }
    .stat-label { font-size: 0.8rem; color: #6c757d; font-weight: 500; }
    .rating-input .stars { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .star-rating { font-size: 1.5rem; color: #dee2e6; cursor: pointer; transition: color 0.2s; }
    .star-rating:hover, .star-rating.active { color: #ffd700; }
    .form-label { font-weight: 600; color: #1a472a; }
    .form-control, .form-select { border-radius: 12px; padding: 0.75rem 1rem; }
    .form-control:focus, .form-select:focus { border-color: #1a472a; box-shadow: 0 0 0 0.2rem rgba(26, 71, 42, 0.25); }
    .btn-primary-custom { background: linear-gradient(135deg, #1a472a, #2d5a3f); color: white; border: none; border-radius: 12px; padding: 0.75rem 2rem; font-weight: 600; transition: all 0.3s ease; }
    .btn-primary-custom:hover { background: linear-gradient(135deg, #2d5a3f, #1a472a); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(26, 71, 42, 0.3); color: white; }
    .itinerary-day { background: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid #1a472a; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .itinerary-place { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.5rem; }
    .place-time { background: #1a472a; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .itinerary-loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; background: #f8f9fa; border-radius: 20px; }
    .loading-title { color: #1a472a; font-weight: 600; }
    .category-badge { position: absolute; top: 12px; left: 12px; background: rgba(26, 71, 42, 0.9); color: #fff; padding: 0.35rem 0.9rem; border-radius: 16px; font-size: 0.8rem; font-weight: 600; z-index: 2; }
    .default-place-img { width: 100%; height: 200px; object-fit: cover; background: #e9ecef url('https://via.placeholder.com/400x200?text=Image+Not+Available') center center no-repeat; border-top-left-radius: 15px; border-top-right-radius: 15px; display: block; }
    .calendar-container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .calendar-header { text-align: center; padding: 10px; background: #1a472a; color: white; border-radius: 5px 5px 0 0; display: flex; align-items: center; justify-content: space-between; }
    .calendar-title { flex: 1; font-size: 1.5rem; font-weight: 600; }
    .calendar-nav-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0 1rem; transition: color 0.2s; }
    .calendar-nav-btn:hover { color: #ffd700; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: #6c757d; padding: 10px 0; border-bottom: 1px solid #dee2e6; }
    .calendar-grid { min-height: 240px; display: grid; grid-template-columns: repeat(7, 1fr); }
    .calendar-cell {
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s, box-shadow 0.2s, color 0.2s;
      padding: 8px 0;
      margin: 2px;
      text-align: center;
      position: relative;
      font-weight: 500;
    }
    .calendar-cell:hover, .calendar-cell:focus {
      background: #e3f2fd;
      color: #1a472a;
      box-shadow: 0 2px 8px rgba(26,71,42,0.08);
      z-index: 2;
    }
    .calendar-cell.selected {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: #fff;
      font-weight: 700;
      box-shadow: 0 4px 16px rgba(26,71,42,0.15);
    }
    .calendar-cell.event-day:not(.selected) {
      background: #fffbe6;
      border: 1px solid #ffd700;
    }
    .calendar-cell.today {
      border: 2px solid #1a472a;
    }
    .calendar-cell .event-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      background: #ffd700;
      border-radius: 50%;
      margin-left: 4px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  {% if messages %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
      {% for message in messages %}
        <div class="toast show align-items-center text-bg-{{ message.tags }} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex"><div class="toast-body">{{ message }}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-custom sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="{% url 'core:home' %}">South India Tourism</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{% url 'core:home' %}">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#places">Places</a></li>
          <li class="nav-item"><a class="nav-link" href="#booking">Plan Your Trip</a></li>
          {% if user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{% url 'core:my_favorites' %}"><i class="fas fa-heart"></i> My Favorites</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'core:profile' %}"><i class="fas fa-user"></i> Profile</a></li>
            <li class="nav-item"><form action="{% url 'logout' %}" method="post" class="d-inline">{% csrf_token %}<button type="submit" class="btn btn-light nav-btn">Logout</button></form></li>
          {% else %}
            <li class="nav-item"><a href="{% url 'login' %}" class="btn btn-light nav-btn">Login</a></li>
            <li class="nav-item"><a href="{% url 'signup' %}" class="btn btn-outline-light nav-btn">Sign Up</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section p-0">
    <div id="apHeroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="4000">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="https://images.unsplash.com/photo-1502086223501-7ea6ecd79368?auto=format&fit=crop&w=1920&q=80" class="d-block w-100 hero-img" alt="Andhra Beach">
          <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-3">
            <h2 class="fw-bold">Visakhapatnam Beaches</h2>
            <p>Relax on the golden sands of Andhra's coast.</p>
          </div>
        </div>
        <div class="carousel-item">
          <img src="https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=1920&q=80" class="d-block w-100 hero-img" alt="Tirupati Temple">
          <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-3">
            <h2 class="fw-bold">Tirupati Temple</h2>
            <p>Experience the spiritual heart of Andhra Pradesh.</p>
          </div>
        </div>
        <div class="carousel-item">
          <img src="https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=1920&q=80" class="d-block w-100 hero-img" alt="Araku Valley">
          <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-3">
            <h2 class="fw-bold">Araku Valley</h2>
            <p>Explore the lush hills and coffee plantations of Araku.</p>
          </div>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#apHeroCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
      <button class="carousel-control-next" type="button" data-bs-target="#apHeroCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
      <div style="position:absolute;inset:0;background:linear-gradient(rgba(0,0,0,0.3),rgba(0,0,0,0.6));z-index:2;"></div>
      <div class="hero-overlay d-flex flex-column align-items-center justify-content-center text-center">
        <h1 class="hero-title text-white animate__animated animate__fadeInDown mb-3" style="font-size:3.5rem;font-weight:700;text-shadow:0 3px 10px rgba(0,0,0,0.6);">Discover {{ state.name }}</h1>
        <p class="hero-subtitle text-white animate__animated animate__fadeInUp animate__delay-1s mb-4" style="font-size:1.5rem;text-shadow:0 2px 8px rgba(0,0,0,0.5);">{{ state.tagline|default:"The Land of Heritage" }}</p>
        <div class="d-flex flex-column flex-md-row gap-3 animate__animated animate__fadeInUp animate__delay-2s align-items-center justify-content-center">
            {% include 'core/partials/favorite_button.html' %}
            <a href="#booking" class="btn btn-lg btn-primary ms-2">Plan Your Trip</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Secondary Navigation -->
  <nav class="secondary-nav sticky-top">
    <div class="container">
      <ul class="nav justify-content-center">
        <li class="nav-item"><a class="nav-link" href="#overview">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="#places">Places to Visit</a></li>
        <li class="nav-item"><a class="nav-link" href="#interactive-map">Interactive Map</a></li>
        <li class="nav-item"><a class="nav-link" href="#cuisine">Cuisine</a></li>
        <li class="nav-item"><a class="nav-link" href="#events">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="#reviews">Traveler Reviews</a></li>
        <li class="nav-item"><a class="nav-link" href="#safety">Safety Tips</a></li>
        <li class="nav-item"><a class="nav-link" href="#booking">Plan / Inquiry</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <!-- State Details Section -->
    <section class="state-details py-6" id="overview">
      <div class="container">
        <ul class="nav nav-tabs state-tabs mb-4" id="stateTabs" role="tablist">
          <li class="nav-item" role="presentation"><a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview-content" role="tab" aria-selected="true">Overview</a></li>
          <li class="nav-item" role="presentation"><a class="nav-link" id="history-tab" data-bs-toggle="tab" href="#history-content" role="tab">History</a></li>
          <li class="nav-item" role="presentation"><a class="nav-link" id="culture-tab" data-bs-toggle="tab" href="#culture-content" role="tab">Culture</a></li>
          <li class="nav-item" role="presentation"><a class="nav-link" id="best-time-tab" data-bs-toggle="tab" href="#best-time-content" role="tab">Best Time</a></li>
        </ul>
        <div class="tab-content" id="stateTabsContent">
          <div class="tab-pane fade show active" id="overview-content" role="tabpanel">
            <h2>Overview of {{ state.name }}</h2>
            <p class="section-content">{{ state.description|linebreaks }}</p>
          </div>
          <div class="tab-pane fade" id="history-content" role="tabpanel">
            <h2>History</h2>
            <p class="section-content">{{ state.history|linebreaks }}</p>
          </div>
          <div class="tab-pane fade" id="culture-content" role="tabpanel">
            <h2>Culture</h2>
            <p class="section-content">{{ state.culture|linebreaks }}</p>
          </div>
          <div class="tab-pane fade" id="best-time-content" role="tabpanel">
            <h2>Best Time to Visit</h2>
            <p class="section-content">{{ state.best_time_to_visit|linebreaks }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Places to Visit Section -->
    <section class="places-section py-6 bg-light" id="places">
      <div class="container">
        <h2 class="section-title text-center mb-5">Explore Andhra Pradesh</h2>
        <div class="mb-5">
          <div class="recommendations-header text-center mb-4">
            <h4><i class="fas fa-magic"></i> AI-Powered Andhra Recommendations</h4>
            <p>Get personalized suggestions for your Andhra adventure!</p>
          </div>
          <div class="recommendation-filters mb-4">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="filter-card">
                  <label class="form-label"><i class="fas fa-map-marker-alt"></i> Your Location</label>
                  <select id="user-place" class="form-select">
                    <option value="">Select current place</option>
                    {% for p in places_with_weather %}
                      <option value="{{ p.place.name }}" data-lat="{{ p.latitude }}" data-lng="{{ p.longitude }}">{{ p.place.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="filter-card">
                  <label class="form-label"><i class="fas fa-tag"></i> Interest</label>
                  <select id="gemini-place-type" class="form-select">
                    <option value="tourist_attraction">üèõÔ∏è Attractions</option>
                    <option value="hindu_temple">üïç Temples</option>
                    <option value="park">üå≥ Parks & Nature</option>
                    <option value="restaurant">üçΩÔ∏è Restaurants</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="filter-card">
                  <label class="form-label"><i class="fas fa-wallet"></i> Budget</label>
                  <select id="budget" class="form-select">
                    <option value="low">üí∞ Budget</option>
                    <option value="medium">üí≥ Moderate</option>
                    <option value="high">üíé Premium</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="filter-card">
                  <label class="form-label"><i class="fas fa-clock"></i> Duration</label>
                  <select id="duration" class="form-select">
                    <option value="short">‚è∞ Quick Visit</option>
                    <option value="medium">üïê Half Day</option>
                    <option value="long">üåÖ Full Day</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="text-center mt-4">
              <button class="btn btn-primary-custom btn-lg me-2" onclick="fetchGeminiRecommendations()"><i class="fas fa-magic"></i> Get Andhra Recommendations</button>
              <button class="btn btn-outline-secondary" onclick="clearRecommendations()"><i class="fas fa-sync-alt"></i> Clear</button>
            </div>
          </div>
          <div id="gemini-recommended-places" class="recommendations-container">
            <div class="recommendation-placeholder text-center">
              <i class="fas fa-compass fa-3x text-muted mb-3"></i>
              <h5>Ready to Discover Andhra Pradesh?</h5>
              <p>Select your preferences above and get recommendations for Andhra's best destinations.</p>
            </div>
          </div>
        </div>
        <div class="mb-4 text-center">
          <select id="categoryFilter" class="form-select w-auto d-inline-block mx-auto">
            <option value="all">All Categories</option>
            <option value="religious">üïç Religious</option>
            <option value="natural">üèîÔ∏è Natural</option>
            <option value="historical">üèõÔ∏è Historical</option>
            <option value="cultural">üé≠ Cultural</option>
            <option value="adventure">üèÉ Adventure</option>
            <option value="entertainment">üé™ Entertainment</option>
          </select>
          <div id="place-count" class="mt-2"></div>
        </div>
        <!-- Places List -->
        <div class="row" id="places-list">
          {% for place_data in places_with_weather %}
            <div class="col-md-6 col-lg-4 mb-4 place-card-wrapper" data-category="{{ place_data.place.category|lower }}">
              <div class="card place-card">
                <!-- Category Badge always on top -->
                <div class="category-badge">
                  {{ place_data.place.category|title }}
                </div>
                {% if place_data.place.image %}
                  <img src="{{ place_data.place.image.url }}" class="card-img-top" alt="{{ place_data.place.name }}">
                {% else %}
                  <div class="default-place-img"></div>
                {% endif %}
                <div class="card-body">
                  <h5 class="card-title">{{ place_data.place.name }}</h5>
                  <p class="card-text">{{ place_data.place.description }}</p>
                  {% if place_data.weather %}
                    <div class="weather-info mb-3">
                      <h6>Current Weather</h6>
                      <p><i class="fas fa-temperature-high"></i> Temperature: {{ place_data.weather.temperature }}¬∞C</p>
                      <p><i class="fas fa-cloud"></i> Condition: {{ place_data.weather.condition }}</p>
                    </div>
                  {% endif %}
                  <div class="card-actions">
                    <button class="btn btn-outline-primary btn-map" onclick="showPlaceOnMap('{{ place_data.latitude }}', '{{ place_data.longitude }}', '{{ place_data.place.name|escapejs }}')">
                      <i class="fas fa-map-marker-alt"></i> Show on Map
                    </button>
                    {% if user.is_authenticated %}
                      <form method="post" action="{% url 'core:add_favorite' place_data.place.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-secondary btn-sm">
                          <i class="far fa-heart"></i>
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="col-12 text-center">
              <p>No places found for this category.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Interactive Map Section -->
    <section class="interactive-map-section py-6" id="interactive-map">
      <div class="container">
        <div class="map-navigation-card text-center">
          <h2 class="section-title mb-3">Interactive Travel Map</h2>
          <p class="lead mb-4">Explore {{ state.name }}'s attractions with our interactive map.</p>
          <div class="map-preview">
            <i class="fas fa-map-marked-alt fa-4x mb-3"></i>
            <h5>Ready to Explore?</h5>
            <a href="{% url 'core:map_view' %}" class="btn btn-primary-custom btn-lg mt-3"><i class="fas fa-map"></i> Open Full Map</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Local Cuisine and Dining Recommendations -->
    <section class="cuisine-section py-6" id="cuisine">
      <div class="container">
        <h2 class="section-title text-center mb-5">Local Cuisine and Dining Recommendations</h2>
        <div class="row">
          <div class="col-md-4 mb-4">
            <div class="card cuisine-card h-100">
              <div class="card-body">
                <h4>Iconic Dishes</h4>
                <p>Indulge in Andhra Pradesh's culinary delights:</p>
                <ul>
                  {% for cuisine in state.cuisines.all %}
                    <li><strong>{{ cuisine.name }}:</strong> {{ cuisine.description }}</li>
                  {% empty %}
                    <li>No iconic dishes listed.</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card cuisine-card h-100">
              <div class="card-body">
                <h4>Top Restaurants</h4>
                {% for restaurant in state.restaurants.all %}
                  <div class="restaurant-item mb-3">
                    <h6>{{ restaurant.name }}</h6>
                    <p><strong>Specialty:</strong> {{ restaurant.specialty }}</p>
                    <p><strong>Average Cost:</strong> ‚Çπ{{ restaurant.average_cost }} per person.</p>
                  </div>
                {% empty %}
                  <p>No top restaurants listed.</p>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card cuisine-card h-100">
              <div class="card-body">
                <h4>Best Hotels</h4>
                {% for hotel in state.hotels.all %}
                  <div class="hotel-item mb-3">
                    <h6>{{ hotel.name }}</h6>
                    <p><strong>Location:</strong> {{ hotel.location }}</p>
                    <p><strong>Rating:</strong> {{ hotel.rating }}/5</p>
                    <p><strong>Price Range:</strong> ‚Çπ{{ hotel.price_range }}</p>
                  </div>
                {% empty %}
                  <p>No hotels listed.</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Events and Festivals -->
    <section class="events-section py-6 bg-light" id="events">
      <div class="container">
        <div class="calendar-container mb-5">
          <div class="calendar-header">
            <button id="calendarPrev" class="calendar-nav-btn" aria-label="Previous Month">&#8592;</button>
            <span class="calendar-title">Andhra Pradesh Events & Festivals - <span id="calendarMonthYear"></span></span>
            <button id="calendarNext" class="calendar-nav-btn" aria-label="Next Month">&#8594;</button>
          </div>
          <div class="calendar-days" id="calendarDays">
            <div class="calendar-day">Sun</div><div class="calendar-day">Mon</div><div class="calendar-day">Tue</div>
            <div class="calendar-day">Wed</div><div class="calendar-day">Thu</div><div class="calendar-day">Fri</div><div class="calendar-day">Sat</div>
          </div>
          <div class="calendar-grid" id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); background: #fff;"></div>
        </div>
        <div class="event-list" id="eventList">
          <h3>Events & Festivals</h3>
          <div id="eventPrompt" class="event-item"><p>Please select a date on the calendar to view events or festivals.</p></div>
        </div>
      </div>
      <script>
        // Andhra Pradesh Events & Festivals (hardcoded for calendar)
        const events = [
          { date: new Date('2025-01-14'), title: 'Makar Sankranti', place: 'Throughout Andhra Pradesh', description: 'Harvest festival celebrated with kite flying, rangoli, and traditional foods.' },
          { date: new Date('2025-03-22'), title: 'Ugadi', place: 'Throughout Andhra Pradesh', description: 'Telugu New Year celebrated with special dishes and rituals.' },
          { date: new Date('2025-04-10'), title: 'Sri Rama Navami', place: 'Bhadrachalam', description: 'Celebration of Lord Rama\'s birth with processions and rituals.' },
          { date: new Date('2025-08-28'), title: 'Krishna Pushkaralu', place: 'Vijayawada', description: 'River festival held once every 12 years on the banks of Krishna River.' },
          { date: new Date('2025-10-12'), title: 'Dasara', place: 'Vijayawada', description: 'Victory of good over evil, celebrated with processions and fairs.' },
          { date: new Date('2025-11-01'), title: 'Deepavali', place: 'Throughout Andhra Pradesh', description: 'Festival of lights celebrated with fireworks and sweets.' }
        ];
        let currentMonth, currentYear, selectedDate = null;
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        function renderCalendar(month, year) {
          currentMonth = month;
          currentYear = year;
          const calendarGrid = document.getElementById('calendarGrid');
          const monthYear = document.getElementById('calendarMonthYear');
          monthYear.textContent = months[month] + ' ' + year;
          calendarGrid.innerHTML = '';
          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const today = new Date();
          for (let i = 0; i < firstDay; i++) {
            calendarGrid.innerHTML += '<div class="calendar-cell"></div>';
          }
          for (let d = 1; d <= daysInMonth; d++) {
            const cellDate = new Date(year, month, d);
            const isToday = cellDate.toDateString() === today.toDateString();
            const hasEvent = events.some(ev => ev.date.toDateString() === cellDate.toDateString());
            const isSelected = selectedDate && cellDate.toDateString() === selectedDate.toDateString();
            let tooltip = '';
            if (hasEvent) {
              const eventTitles = events.filter(ev => ev.date.toDateString() === cellDate.toDateString()).map(ev => ev.title).join(', ');
              tooltip = ` title="${eventTitles}"`;
            }
            calendarGrid.innerHTML += `<div class="calendar-cell${hasEvent ? ' event-day' : ''}${isToday ? ' today' : ''}${isSelected ? ' selected' : ''}" data-date="${cellDate.toISOString()}"${tooltip}>${d}${hasEvent ? ' <span class="event-dot"></span>' : ''}</div>`;
          }
        }
        function renderEvents(selected = null) {
          const eventList = document.getElementById('eventList');
          let html = '<h3>Events & Festivals</h3>';
          if (!selected) {
            html += '<div id="eventPrompt" class="event-item"><p>Please select a date on the calendar to view events or festivals.</p></div>';
          } else {
            const filteredEvents = events.filter(ev => ev.date.toDateString() === selected.toDateString());
            if (filteredEvents.length === 0) {
              html += '<div class="event-item"><p>No events or festivals for this date.</p></div>';
            } else {
              filteredEvents.forEach(ev => {
                html += `<div class="event-item">
                  <h4>${ev.title} <span class="event-date">(${ev.date.toLocaleDateString('en-IN')})</span></h4>
                  <p><strong>Location:</strong> ${ev.place}</p>
                  <p>${ev.description}</p>
                </div>`;
              });
            }
          }
          eventList.innerHTML = html;
        }
        function prevMonth() {
          if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
          } else {
            currentMonth--;
          }
          selectedDate = null;
          renderCalendar(currentMonth, currentYear);
          renderEvents();
        }
        function nextMonth() {
          if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
          } else {
            currentMonth++;
          }
          selectedDate = null;
          renderCalendar(currentMonth, currentYear);
          renderEvents();
        }
        document.addEventListener('DOMContentLoaded', function() {
          const now = new Date();
          currentMonth = now.getMonth();
          currentYear = now.getFullYear();
          renderCalendar(currentMonth, currentYear);
          renderEvents();
          document.getElementById('calendarGrid').addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('calendar-cell') && e.target.dataset.date) {
              e.target.classList.add('hovered');
            }
          });
          document.getElementById('calendarGrid').addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('calendar-cell')) {
              e.target.classList.remove('hovered');
            }
          });
          document.getElementById('calendarGrid').addEventListener('click', function(e) {
            if (e.target.classList.contains('calendar-cell') && e.target.dataset.date) {
              selectedDate = new Date(e.target.dataset.date);
              renderCalendar(currentMonth, currentYear);
              renderEvents(selectedDate);
            }
          });
          document.getElementById('calendarPrev').addEventListener('click', prevMonth);
          document.getElementById('calendarNext').addEventListener('click', nextMonth);
        });
      </script>
    </section>

    <!-- Plan Your Trip -->
    <section class="trip-planning-section py-6 bg-light" id="booking">
      <div class="container">
        <h2 class="section-title text-center mb-5">
          <i class="fas fa-route"></i> Plan Your Perfect Trip
        </h2>
        <ul class="nav nav-tabs trip-tabs mb-4" id="tripTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="itinerary-tab" data-bs-toggle="tab" data-bs-target="#itinerary" type="button" role="tab">
              <i class="fas fa-calendar-alt"></i> Itinerary Builder
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
              <i class="fas fa-star"></i> Traveler Reviews
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking-form" type="button" role="tab">
              <i class="fas fa-envelope"></i> Custom Inquiry
            </button>
          </li>
        </ul>
        <div class="tab-content" id="tripTabsContent">
          <!-- Itinerary Builder Tab -->
          <div class="tab-pane fade show active" id="itinerary" role="tabpanel">
            <div class="row">
              <div class="col-lg-8">
                <div class="itinerary-builder-card">
                  <h4 class="mb-4">
                    <i class="fas fa-map-marked-alt"></i> Create Your Custom Itinerary
                  </h4>
                  <form id="itineraryForm" class="mb-4">
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-calendar"></i> Trip Duration
                          </label>
                          <select class="form-select" id="tripDuration">
                            <option value="1">1 Day</option>
                            <option value="2">2 Days</option>
                            <option value="3" selected>3 Days</option>
                            <option value="5">5 Days</option>
                            <option value="7">1 Week</option>
                            <option value="10">10 Days</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-users"></i> Travel Style
                          </label>
                          <select class="form-select" id="travelStyle">
                            <option value="adventure">Adventure</option>
                            <option value="cultural">Cultural</option>
                            <option value="relaxation">Relaxation</option>
                            <option value="luxury">Luxury</option>
                            <option value="budget">Budget</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-map-marker-alt"></i> Starting Point
                          </label>
                          <input type="text" class="form-control" id="startingPoint" placeholder="e.g., Visakhapatnam" />
                        </div>
                      </div>
                    </div>
                    <button type="button" class="btn btn-primary-custom" onclick="generateItinerary()">
                      <i class="fas fa-magic"></i> Generate Itinerary
                    </button>
                  </form>
                  <div id="generatedItinerary" class="d-none">
                    <h5 class="mb-3">Your Custom Itinerary</h5>
                    <div id="itineraryDays"></div>
                    <div class="mt-3">
                      <button class="btn btn-success me-2" onclick="saveItinerary()">
                        <i class="fas fa-save"></i> Save Itinerary
                      </button>
                      <button class="btn btn-info me-2" onclick="exportItinerary()">
                        <i class="fas fa-download"></i> Export PDF
                      </button>
                      <button class="btn btn-secondary" onclick="resetItinerary()">
                        <i class="fas fa-refresh"></i> Reset
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="quick-tips-card">
                  <h5 class="mb-3">
                    <i class="fas fa-lightbulb"></i> Planning Tips
                  </h5>
                  <div class="tips-list">
                    <div class="tip-item">
                      <i class="fas fa-clock text-primary"></i>
                      <span>Best time to visit: {{ state.best_time_to_visit|default:"October to March" }}</span>
                    </div>
                    <div class="tip-item">
                      <i class="fas fa-thermometer-half text-warning"></i>
                      <span>Weather: {{ state.climate|default:"Tropical climate with monsoon rains" }}</span>
                    </div>
                    <div class="tip-item">
                      <i class="fas fa-money-bill-wave text-success"></i>
                      <span>Budget: ‚Çπ2000-5000 per day for moderate travel</span>
                    </div>
                    <div class="tip-item">
                      <i class="fas fa-bus text-info"></i>
                      <span>Transport: Well-connected by road, rail, and air</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Traveler Reviews Tab -->
          <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8 mb-4 mb-lg-0">
                            <div class="reviews-section">
                                <h4 class="mb-4"><i class="fas fa-comments"></i> What Travelers Say</h4>
                                <div class="review-filters mb-4">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <select class="form-select" id="reviewFilter">
                                                <option value="all">All Reviews</option>
                                                <option value="5">5 Star Reviews</option>
                                                <option value="4">4+ Star Reviews</option>
                                                <option value="3">3+ Star Reviews</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select" id="placeFilter">
                                                <option value="all">All Places</option>
                                                {% for place_data in places_with_weather %}
                                                    <option value="{{ place_data.place.id }}">{{ place_data.place.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-primary-custom w-100" onclick="filterReviews()">
                                                <i class="fas fa-filter"></i> Filter Reviews
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="reviewsContainer">
                                    {% with has_reviews=False review_count=0 %}
                                        {% for place_data in places_with_weather %}
                                            {% for review in place_data.place.reviews.all %}
                                                {% if not has_reviews %}{% with has_reviews=True %}{% endwith %}{% endif %}
                                                {% with review_count=review_count|add:1 %}{% endwith %}
                                                <div class="review-card mb-3" data-rating="{{ review.rating }}" data-place="{{ place_data.place.id }}" style="display: {% if review_count > 10 %}none{% else %}block{% endif %};">
                                                    <div class="review-header">
                                                        <div class="reviewer-info">
                                                            <img src="https://ui-avatars.com/api/?name={{ review.user.username }}&background=1a472a&color=fff" class="reviewer-avatar" alt="{{ review.user.username }}">
                                                            <div>
                                                                <h6 class="mb-0">{{ review.user.username }}</h6>
                                                                <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                                                            </div>
                                                        </div>
                                                        <div class="review-rating">
                                                            {% for i in "12345" %}
                                                                <i class="fas fa-star {% if forloop.counter <= review.rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    <div class="review-content">
                                                        <h6 class="review-place">{{ place_data.place.name }}</h6>
                                                        <p class="review-comment">{{ review.comment }}</p>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% endfor %}
                                        {% if not has_reviews %}
                                            <div id="no-reviews-message" class="text-center py-4">
                                                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                                                <p class="text-muted">No reviews yet for this state.</p>
                                            </div>
                                        {% endif %}
                                        {% if review_count > 10 %}
                                            <div class="text-center mb-3">
                                                <button id="showMoreReviewsBtn" class="btn btn-outline-primary btn-sm">Show More Reviews</button>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="review-stats-card">
                                <h5 class="mb-3"><i class="fas fa-chart-bar"></i> Review Statistics</h5>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ state.reviews.count }}</div>
                                        <div class="stat-label">Total Reviews</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">{% if state.reviews.count > 0 %}{{ state.average_rating|floatformat:1 }}{% else %}0{% endif %}</div>
                                        <div class="stat-label">Average Rating</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">{{ places_with_weather|length }}</div>
                                        <div class="stat-label">Places Reviewed</div>
                                    </div>
                                </div>
                                {% if user.is_authenticated %}
                                    <div class="add-review-section mt-4">
                                        <h6 class="mb-3">Share Your Experience</h6>
                                        <form id="addReviewForm">
                                            <div class="form-group mb-2">
                                                <select class="form-select" id="reviewPlace" required>
                                                    <option value="">Select a place</option>
                                                    {% for place_data in places_with_weather %}
                                                        <option value="{{ place_data.place.id }}">{{ place_data.place.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group mb-2">
                                                <div class="rating-input">
                                                    <label class="form-label">Rating:</label>
                                                    <div class="stars">
                                                        {% for i in "12345" %}
                                                            <i class="fas fa-star star-rating" data-rating="{{ forloop.counter }}"></i>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group mb-2">
                                                <textarea class="form-control" id="reviewComment" rows="3" placeholder="Share your experience..." required></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary-custom w-100">
                                                <i class="fas fa-paper-plane"></i> Submit Review
                                            </button>
                                        </form>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Travel Safety Tips -->
    <section class="safety-section py-6" id="safety">
      <div class="container">
        <h2 class="section-title text-center mb-5">Travel Safety Tips</h2>
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card safety-card h-100">
              <div class="card-body">
                <h4>General Safety Tips</h4>
                <ul class="safety-tips-list">
                  <li>Be cautious of pickpockets in crowded areas like markets and temples.</li>
                  <li>Keep your belongings secure while visiting popular tourist spots.</li>
                  <li>Follow local customs and dress codes when visiting religious sites.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card safety-card h-100">
              <div class="card-body">
                <h4>Emergency Contacts</h4>
                <ul class="safety-tips-list">
                  <li><strong>Police:</strong> 100</li>
                  <li><strong>Tourist Helpline:</strong> 1800-425-31111</li>
                  <li><strong>Apollo Hospital (Visakhapatnam):</strong> +91-891-7179-1090</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  

  <!-- Toast container for notifications (for itinerary/review actions) -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="itineraryToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
              <strong class="me-auto"><i class="fas fa-check-circle text-success me-2"></i>Success</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
              Itinerary saved! (This is a demo).
          </div>
      </div>
  </div>

  <!-- Footer -->
  <footer class="footer py-4">
    <div class="container text-center">
      <p class="credit">Created by <span>Team South India Tourism</span> | ¬© 2025</p>
    </div>
  </footer>

  <!-- Back to Top Button -->
  <a href="#" class="back-to-top">
    <i class="fas fa-chevron-up"></i>
  </a>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    // Global variables for map functionality
    let recommendationMap = null;
    let currentMarker = null;
    let mainPlacesMap = null;
    let mainPlacesMarker = null;
    let mainMap = null;
    let mapMarkers = [];
    let placesService = null;
    let geocoder = null;

    // CSRF Token function
    function getCSRFToken() {
      const token = document.querySelector('meta[name="csrf-token"]');
      return token ? token.getAttribute('content') : null;
    }

    // Initialize page functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize AOS
      AOS.init({ duration: 1000, once: true });
      
      // Initialize navbar scroll behavior
      const navbar = document.querySelector('.navbar');
      const secondaryNav = document.querySelector('.secondary-nav');
      
      window.addEventListener('scroll', () => {
        if (secondaryNav) {
          if (window.scrollY > 100) {
            navbar.style.display = 'none';
            secondaryNav.classList.add('active');
          } else {
            navbar.style.display = '';
            secondaryNav.classList.remove('active');
          }
        }
      });

      // Back to Top Button
      const backToTopButton = document.querySelector('.back-to-top');
      
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          backToTopButton.classList.add('show');
        } else {
          backToTopButton.classList.remove('show');
        }
      });

      backToTopButton.addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });

      // Active Navigation Link
      const sections = document.querySelectorAll('.section');
      const navLinks = document.querySelectorAll('.secondary-nav .nav-link');

      window.addEventListener('scroll', () => {
        let current = '';
        
        sections.forEach(section => {
          const sectionTop = section.offsetTop;
          const sectionHeight = section.clientHeight;
          
          if (window.scrollY >= (sectionTop - 200)) {
            current = section.getAttribute('id');
          }
        });

        navLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href').substring(1) === current) {
            link.classList.add('active');
          }
        });
      });

      // Smooth Scroll for Navigation
      document.querySelectorAll('.secondary-nav .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href').substring(1);
          const targetSection = document.getElementById(targetId);
          
          if (targetSection) {
            targetSection.scrollIntoView({
              behavior: 'smooth'
            });
          }
        });
      });
    });

    // Enhanced fetchGeminiRecommendations function (updated for Telangana logic)
    function fetchGeminiRecommendations() {
        const placeSelect = document.getElementById("user-place");
        const selectedOption = placeSelect.options[placeSelect.selectedIndex];
        const userPlace = selectedOption.value;
        const latitude = selectedOption.getAttribute('data-lat');
        const longitude = selectedOption.getAttribute('data-lng');
        const placeType = document.getElementById("gemini-place-type").value;
        const budget = document.getElementById("budget").value;
        const duration = document.getElementById("duration").value;

        if (!latitude || !longitude) {
            alert("Please select a valid place");
            return;
        }

        const geminiRecommendedPlacesDiv = document.getElementById("gemini-recommended-places");
        geminiRecommendedPlacesDiv.innerHTML = `
            <div class="recommendation-loading">
                <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                <h5 class="mt-3 text-muted">Analyzing your preferences...</h5>
                <p class="text-muted">Finding the perfect places for you</p>
            </div>
        `;

        const url = `${geminiRecommendationsUrl}?latitude=${latitude}&longitude=${longitude}&user_place=${encodeURIComponent(userPlace)}&place_type=${placeType}&budget=${budget}&duration=${duration}&enhanced=true&context=andhra_pradesh`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    geminiRecommendedPlacesDiv.innerHTML = `<div class="alert alert-danger m-3"><i class="fas fa-exclamation-triangle"></i> Error: ${data.error}</div>`;
                    return;
                }

                const places = data.gemini_recommended_places;
                const weatherData = data.weather_data;

                if (!places || places.length === 0) {
                    geminiRecommendedPlacesDiv.innerHTML = `
                        <div class="alert alert-info m-3">
                            <i class="fas fa-info-circle"></i> No recommendations available at the moment.
                        </div>
                    `;
                    return;
                }

                // Display weather information with enhanced styling
                let html = `
                    <div class="recommendation-weather m-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-cloud-sun"></i> Current Weather
                                </h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Temperature:</strong> ${weatherData.temperature}¬∞C</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Weather:</strong> ${weatherData.weather}</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Humidity:</strong> ${weatherData.humidity}%</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Description:</strong> ${weatherData.description}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row m-3">
                `;

                places.forEach(place => {
                    const rating = place.rating || 'N/A';
                    const reasoning = place.reasoning || 'No description available';
                    html += `
                        <div class="col-md-6 mb-4">
                            <div class="card recommendation-card">
                                <div class="card-body">
                                    <h5 class="card-title">${place.name}</h5>
                                    <span class="recommendation-badge">
                                        <i class="fas fa-star"></i> Rating: ${rating}
                                    </span>
                                    <div class="recommendation-weather">
                                        <h6><i class="fas fa-cloud"></i> Current Weather</h6>
                                        <p class="mb-1"><i class="fas fa-temperature-high"></i> ${weatherData.temperature}¬∞C</p>
                                        <p class="mb-1"><i class="fas fa-tint"></i> ${weatherData.humidity}% humidity</p>
                                        <p class="mb-0"><i class="fas fa-cloud-sun"></i> ${weatherData.weather}</p>
                                    </div>
                                    <p class="location-info">
                                        <i class="fas fa-map-marker-alt"></i> 
                                        ${parseFloat(place.latitude).toFixed(4)}, ${parseFloat(place.longitude).toFixed(4)}
                                    </p>
                                    <p class="reasoning">${reasoning}</p>
                                    <div class="recommendation-actions">
                                        <button class="btn btn-primary" 
                                                onclick="showOnMap(${place.latitude }, ${place.longitude}, '${place.name.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-map-marker-alt"></i> Show on Map
                                        </button>
                                        <button class="btn btn-outline-secondary" 
                                                onclick="addToFavorites('${place.name.replace(/'/g, "\\'")}', ${place.latitude}, ${place.longitude}, event)">
                                            <i class="far fa-heart"></i> Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += "</div>";
                geminiRecommendedPlacesDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                geminiRecommendedPlacesDiv.innerHTML = `<div class="alert alert-danger m-3"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
            });
    }

    // Telangana-style map logic
    function showOnMap(latitude, longitude, placeName) {
      const mapModal = new bootstrap.Modal(document.getElementById('mapModal'));
      mapModal.show();
      if (!recommendationMap) {
        recommendationMap = new google.maps.Map(document.getElementById('modalMapContainer'), {
          center: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
          zoom: 15,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true
        });
      } else {
        recommendationMap.setCenter({ lat: parseFloat(latitude), lng: parseFloat(longitude) });
      }
      if (currentMarker) {
        currentMarker.setMap(null);
      }
      currentMarker = new google.maps.Marker({
        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        map: recommendationMap,
        title: placeName,
        animation: google.maps.Animation.DROP
      });
      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${placeName}</h6><p>Latitude: ${latitude}<br>Longitude: ${longitude}</p></div>`
      });
      currentMarker.addListener('click', () => {
        infoWindow.open(recommendationMap, currentMarker);
      });
      infoWindow.open(recommendationMap, currentMarker);
    }

    function showMainPlaceOnMap(latitude, longitude, placeName) {
      const mapModal = new bootstrap.Modal(document.getElementById('mainPlacesMapModal'));
      mapModal.show();
      if (!mainPlacesMap) {
        mainPlacesMap = new google.maps.Map(document.getElementById('mainPlacesMap'), {
          center: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
          zoom: 15,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true
        });
      } else {
        mainPlacesMap.setCenter({ lat: parseFloat(latitude), lng: parseFloat(longitude) });
      }
      if (mainPlacesMarker) {
        mainPlacesMarker.setMap(null);
      }
      mainPlacesMarker = new google.maps.Marker({
        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        map: mainPlacesMap,
        title: placeName,
        animation: google.maps.Animation.DROP
      });
      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${placeName}</h6><p>Latitude: ${latitude}<br>Longitude: ${longitude}</p></div>`
      });
      mainPlacesMarker.addListener('click', () => {
        infoWindow.open(mainPlacesMap, mainPlacesMarker);
      });
      infoWindow.open(mainPlacesMap, mainPlacesMarker);
    }

    // Function to show a place on the main map (for place cards)
    function showPlaceOnMap(latitude, longitude, placeName) {
      const position = { lat: parseFloat(latitude), lng: parseFloat(longitude) };
      
      // Center map on the place
      mainMap.setCenter(position);
      mainMap.setZoom(15);

      // Add a temporary marker
      const marker = new google.maps.Marker({
        position: position,
        map: mainMap,
        title: placeName,
        animation: google.maps.Animation.DROP
      });

      // Add info window
      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${placeName}</h6></div>`
      });

      marker.addListener('click', () => {
        infoWindow.open(mainMap, marker);
      });

      // Open info window by default
      infoWindow.open(mainMap, marker);

      // Remove marker after 5 seconds
      setTimeout(() => {
        marker.setMap(null);
      }, 5000);
    }

    // Update itineraryDays rendering to use displayItinerary with Telangana-style show on map
    function displayItinerary(itineraryDays, startingPoint) {
      const container = document.getElementById('itineraryDays');
      let html = itineraryDays.map(dayData => `
        <div class="itinerary-day">
          <h6><i class="fas fa-calendar-day"></i> Day ${dayData.day}</h6>
          ${dayData.day === 1 ? `<p class="text-muted mb-3"><i class="fas fa-map-marker-alt"></i> Starting from: ${startingPoint}</p>` : ''}
          ${dayData.places.map((place, index) => {
            const time = getTimeSlot(index, dayData.places.length);
            const aiInsight = dayData.aiInsights ? dayData.aiInsights[index] : null;
            return `
              <div class="itinerary-place">
                <span class="place-time">${time}</span>
                <div class="place-details">
                  <strong>${place.name}</strong>
                  <small class="text-muted d-block">${place.category}</small>
                  ${aiInsight ? `
                    <div class="ai-insight mt-2">
                      <i class="fas fa-robot text-primary"></i>
                      <small class="text-primary">AI Insight: ${aiInsight.reasoning}</small>
                    </div>` : ''}
                </div>
                <div class="place-actions">
                  <button class="btn btn-sm btn-outline-primary" onclick="showPlaceOnMap(${place.latitude || 0}, ${place.longitude || 0}, '${place.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-map-marker-alt"></i>
                  </button>
                </div>
              </div>
            `;
          }).join('')}
          ${dayData.aiInsights && dayData.aiInsights.length > 0 ? `
            <div class="day-summary mt-3 p-3 bg-light rounded">
              <h6><i class="fas fa-lightbulb text-warning"></i> AI Travel Tips for Day ${dayData.day}</h6>
              <ul class="mb-0">
                ${dayData.aiInsights.map(insight => `<li><small>${insight.reasoning}</small></li>`).join('')}
              </ul>
            </div>` : ''}
        </div>
      `).join('');
      container.innerHTML = html;
      document.getElementById('generatedItinerary').classList.remove('d-none');
    }

    // Helper function to get time slots for itinerary places
    function getTimeSlot(index, totalPlaces) {
      const startHour = 9; // Start at 9 AM
      const endHour = 18; // End at 6 PM
      const availableHours = endHour - startHour;
      const timePerPlace = availableHours / totalPlaces;
      const currentHour = startHour + (index * timePerPlace);
      const hour = Math.floor(currentHour);
      const minute = Math.round((currentHour - hour) * 60);
      return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
    }

    // Function to add to favorites
    function addToFavorites(name, latitude, longitude, event) {
        const csrfToken = getCSRFToken();
        
        if (!csrfToken) {
            alert('CSRF token not found. Please refresh the page and try again.');
            return;
        }
        
        fetch('{% url "core:add_recommended_favorite" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                name: name,
                latitude: latitude,
                longitude: longitude
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const button = event.target;
                button.innerHTML = '<i class="fas fa-heart"></i> Added to Favorites';
                button.classList.add('favorited');
                button.disabled = true;
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${name} added to favorites!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            } else {
                alert('Error adding to favorites: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding to favorites: ' + error.message);
        });
    }

    // Map initialization and management
    function initMainMap() {
      mainMap = new google.maps.Map(document.getElementById('mainMap'), {
        center: { lat: 15.9129, lng: 79.7400 }, // Andhra Pradesh coordinates
        zoom: 10,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
      });
      placesService = new google.maps.places.PlacesService(mainMap);
      geocoder = new google.maps.Geocoder();
      
      // Add markers for existing places
      {% for place_data in places_with_weather %}
        addPlaceMarker({{ place_data.latitude }}, {{ place_data.longitude }}, '{{ place_data.place.name|escapejs }}', '{{ place_data.place.description|escapejs }}');
      {% endfor %}
    }

    // Function to add a permanent marker
    function addPlaceMarker(latitude, longitude, name, description) {
      const marker = new google.maps.Marker({
        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        map: mainMap,
        title: name
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${name}</h6><p>${description}</p></div>`
      });

      marker.addListener('click', () => {
        infoWindow.open(mainMap, marker);
      });

      mapMarkers.push(marker);
    }

    // Function to clear map markers
    function clearMapMarkers() {
      mapMarkers.forEach(marker => {
        marker.setMap(null);
      });
      mapMarkers = [];
    }

    // Function to search nearby places
    function searchNearbyPlaces() {
      const searchLocation = document.getElementById('mapSearch').value;
      const placeType = document.getElementById('mapPlaceType').value;

      if (!searchLocation) {
        alert('Please enter a location to search');
        return;
      }

      // Geocode the search location
      geocoder.geocode({ address: searchLocation }, (results, status) => {
        if (status === 'OK') {
          const location = results[0].geometry.location;
          
          // Center map on search location
          mainMap.setCenter(location);
          mainMap.setZoom(14);

          // Search for nearby places
          const request = {
            location: location,
            radius: '5000',
            type: placeType
          };

          placesService.nearbySearch(request, (places, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              // Clear existing markers
              clearMapMarkers();

              // Add new markers
              places.forEach(place => {
                const marker = new google.maps.Marker({
                  position: place.geometry.location,
                  map: mainMap,
                  title: place.name
                });

                const infoWindow = new google.maps.InfoWindow({
                  content: `
                    <div class="p-2">
                      <h6>${place.name}</h6>
                      <p>${place.vicinity || place.formatted_address}</p>
                      ${place.rating ? `<p>Rating: ${place.rating} ‚≠ê</p>` : ''}
                    </div>
                  `
                });

                marker.addListener('click', () => {
                  infoWindow.open(mainMap, marker);
                });

                mapMarkers.push(marker);
              });
            } else {
              alert('No places found nearby');
            }
          });
        } else {
          alert('Location not found');
        }
      });
    }

    // Add this function to clear recommendations
    function clearRecommendations() {
        const geminiRecommendedPlacesDiv = document.getElementById("gemini-recommended-places");
        geminiRecommendedPlacesDiv.innerHTML = `
            <div class="text-center py-5">
                <div class="recommendation-placeholder">
                    <i class="fas fa-compass fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Ready to Discover?</h5>
                    <p class="text-muted">Select your preferences above and get personalized recommendations</p>
                </div>
            </div>
        `;
    }

    // Itinerary management functions
    function saveItinerary() {
      const itineraryData = {
        state: '{{ state.name }}',
        generatedAt: new Date().toISOString(),
        itinerary: document.getElementById('itineraryDays').innerHTML
      };
      localStorage.setItem('savedItinerary', JSON.stringify(itineraryData));
      alert('Itinerary saved successfully!');
    }

    function exportItinerary() {
      const itineraryContent = document.getElementById('itineraryDays').innerText;
      const blob = new Blob([itineraryContent], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '{{ state.name }}_itinerary.txt';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function resetItinerary() {
      document.getElementById('itineraryForm').reset();
      document.getElementById('generatedItinerary').classList.add('d-none');
    }

    // Review filtering function
    function filterReviews() {
      const ratingFilter = document.getElementById('reviewFilter').value;
      const placeFilter = document.getElementById('placeFilter').value;
      const reviewCards = document.querySelectorAll('.review-card');
      
      reviewCards.forEach(card => {
        const rating = card.getAttribute('data-rating');
        const place = card.getAttribute('data-place');
        
        let showCard = true;
        
        // Filter by rating
        if (ratingFilter !== 'all') {
          const cardRating = parseInt(rating);
          const filterRating = parseInt(ratingFilter);
          if (cardRating < filterRating) {
            showCard = false;
          }
        }
        
        // Filter by place
        if (placeFilter !== 'all' && place !== placeFilter) {
          showCard = false;
        }
        
        card.style.display = showCard ? 'block' : 'none';
      });
    }

    // Client-side Category Filtering
    function filterPlacesByCategory() {
      const selectedCategory = document.getElementById('categoryFilter').value;
      const placeCards = document.querySelectorAll('.place-card-wrapper');
      
      placeCards.forEach(card => {
        const cardCategory = card.getAttribute('data-category').toLowerCase();
        
        // Enhanced category matching
        let shouldShow = false;
        
        if (selectedCategory === 'all') {
          shouldShow = true;
        } else {
          // Map filter categories to actual place categories
          const categoryMap = {
            'religious': ['religious', 'temple', 'church', 'mosque', 'gurudwara'],
            'natural': ['natural', 'beach', 'hill', 'mountain', 'forest', 'park', 'lake', 'waterfall'],
            'historical': ['historical', 'fort', 'palace', 'monument', 'museum', 'heritage'],
            'cultural': ['cultural', 'art', 'theater', 'gallery', 'festival'],
            'adventure': ['adventure', 'trek', 'climbing', 'rafting', 'wildlife', 'safari'],
            'entertainment': ['entertainment', 'amusement', 'shopping', 'restaurant', 'cafe']
          };
          
          const matchingCategories = categoryMap[selectedCategory] || [selectedCategory];
          shouldShow = matchingCategories.some(cat => cardCategory.includes(cat));
        }
        
        if (shouldShow) {
          card.style.display = 'block';
          card.classList.add('animate__animated', 'animate__fadeIn');
        } else {
          card.style.display = 'none';
        }
      });
      
      // Show message if no places found
      const visibleCards = document.querySelectorAll('.place-card-wrapper[style*="display: block"]');
      const noPlacesMessage = document.getElementById('no-places-message');
      
      if (visibleCards.length === 0) {
        if (!noPlacesMessage) {
          const messageDiv = document.createElement('div');
          messageDiv.id = 'no-places-message';
          messageDiv.className = 'col-12 text-center mt-4';
          messageDiv.innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> No places found for the selected category. Try selecting "All Categories" to see all available places.
            </div>
          `;
          document.getElementById('places-list').appendChild(messageDiv);
        }
      } else {
        if (noPlacesMessage) {
          noPlacesMessage.remove();
        }
      }
      
      // Update the count display
      updatePlaceCount(visibleCards.length);
    }
    
    // Function to update place count
    function updatePlaceCount(count) {
      const totalPlaces = document.querySelectorAll('.place-card-wrapper').length;
      const countDisplay = document.getElementById('place-count');
      
      if (!countDisplay) {
        const countDiv = document.createElement('div');
        countDiv.id = 'place-count';
        countDiv.className = 'text-center mb-3';
        countDiv.innerHTML = `<small class="text-muted">Showing ${count} of ${totalPlaces} places</small>`;
        document.getElementById('categoryFilter').parentNode.appendChild(countDiv);
      } else {
        countDisplay.innerHTML = `<small class="text-muted">Showing ${count} of ${totalPlaces} places</small>`;
      }
    }
  </script>

  <!-- Map Modal -->
  <div class="modal fade map-modal" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mapModalLabel">Location on Map</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="modalMapContainer" style="height: 500px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Places Map Modal -->
  <div class="modal fade" id="mainPlacesMapModal" tabindex="-1" aria-labelledby="mainPlacesMapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mainPlacesMapModalLabel">
            <i class="fas fa-map-marked-alt"></i> Location on Map
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="mainPlacesMap" style="height: 400px; width: 100%;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Favorite Button Handling -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Handle place favorite buttons
      const placeFavoriteForms = document.querySelectorAll('form[action*="favorite"]');
      placeFavoriteForms.forEach(form => {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const button = this.querySelector('button');
          const isFavorited = button.classList.contains('btn-danger');
          
          // Show loading state
          button.disabled = true;
          button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
          
          // Submit the form
          fetch(this.action, {
            method: 'POST',
            body: new FormData(this),
            headers: {
              'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value,
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // Update button state
              if (isFavorited) {
                button.className = 'btn btn-outline-primary btn-sm mt-2';
                button.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
              } else {
                button.className = 'btn btn-danger btn-sm mt-2';
                button.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
              }
              // Update the form action for the next click
              const newAction = isFavorited ? 
                this.action.replace('remove_favorite', 'add_favorite') :
                this.action.replace('add_favorite', 'remove_favorite');
              this.action = newAction;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            // Reset button state on error
            button.disabled = false;
            if (isFavorited) {
              button.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
            } else {
              button.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
            }
          })
          .finally(() => {
            button.disabled = false;
          });
        });
      });
    });
  </script>

  <!-- State-specific JavaScript -->
  <script src="{% static 'core/js/andhra_pradesh.js' %}"></script>

  <!-- Initialize functionality when DOM is loaded -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      filterPlacesByCategory();
      
      // Initialize star rating functionality
      const stars = document.querySelectorAll('.star-rating');
      stars.forEach(star => {
        star.addEventListener('click', function() {
          const rating = parseInt(this.dataset.rating);
          selectedRating = rating;
          
          // Update star display
          stars.forEach((s, index) => {
            if (index < rating) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });
        });
        
        star.addEventListener('mouseenter', function() {
          const rating = parseInt(this.dataset.rating);
          stars.forEach((s, index) => {
            if (index < rating) {
              s.style.color = '#ffd700';
            }
          });
        });
        
        star.addEventListener('mouseleave', function() {
          stars.forEach((s, index) => {
            if (index < selectedRating) {
              s.style.color = '#ffd700';
            } else {
              s.style.color = '#dee2e6';
            }
          });
        });
      });
      
      // Add review form submission
      const addReviewForm = document.getElementById('addReviewForm');
      if (addReviewForm) {
        addReviewForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const placeId = document.getElementById('reviewPlace').value;
          const comment = document.getElementById('reviewComment').value;
          
          if (!placeId || !comment || selectedRating === 0) {
            alert('Please fill in all fields and select a rating');
            return;
          }
          
          // Submit review via AJAX
          submitReview(placeId, selectedRating, comment);
        });
      }
    });

    // Review system variables
    let selectedRating = 0;

    // Function to submit review
    function submitReview(placeId, rating, comment) {
      const csrfToken = getCSRFToken();
      if (!csrfToken) {
        alert('CSRF token not found. Please refresh the page and try again.');
        return;
      }
      fetch('{% url "core:add_review" 0 %}'.replace('0', placeId), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `rating=${rating}&comment=${encodeURIComponent(comment)}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Review submitted successfully!');
          document.getElementById('addReviewForm').reset();
          selectedRating = 0;
          stars.forEach(star => {
            star.classList.remove('active');
            star.style.color = '#dee2e6';
          });
        } else {
          alert('Error submitting review: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error submitting review');
      });
    }

    // Function to add to favorites
  </script>
</body>
</html>