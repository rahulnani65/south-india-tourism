{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karnataka - South India Tourism</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'core/css/style.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <!-- Load Google Maps JavaScript API -->
  <script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
      key: "AIzaSyD3WSnlZlux7vVPP2LQ7fZvg8O43J01mK8",
      v: "weekly",
      libraries: "places"  // Include Places library for future use (nearby search)
    });
  </script>
  <style>
    .hero-section,
    #karnatakaHeroCarousel,
    .hero-section .carousel-inner,
    .hero-section .carousel-item,
    .hero-section img.d-block.w-100 {
      width: 100vw !important;
      height: 100vh !important;
      min-height: 100vh;
      margin: 0 !important;
      padding: 0 !important;
      border: none;
      box-sizing: border-box;
    }
    .hero-section {
      position: relative;
      overflow: hidden;
      background: #000;
      z-index: 1;
    }
    .hero-section .carousel-item img {
      object-fit: cover;
      width: 100vw;
      height: 100vh;
      min-height: 100vh;
      display: block;
      margin: 0;
      padding: 0;
      border: none;
    }
    .hero-section .carousel-caption {
      bottom: 10vh;
    }
    .hero-section .hero-overlay {
      width: 100vw;
      height: 100vh;
      min-height: 100vh;
      left: 0;
      top: 0;
      margin: 0;
      padding: 0;
      pointer-events: none;
      z-index: 3;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
    }
    @media (max-width: 768px) {
      .hero-section,
      #karnatakaHeroCarousel,
      .hero-section .carousel-inner,
      .hero-section .carousel-item,
      .hero-section img.d-block.w-100,
      .hero-section .hero-overlay {
        width: 100vw !important;
        height: 60vh !important;
        min-height: 60vh;
      }
      .hero-section .carousel-caption {
        bottom: 2vh;
        font-size: 1rem;
      }
    }
    .place-card img {
      height: 200px;
      object-fit: cover;
    }
    .map-modal .modal-dialog {
      max-width: 800px;
    }
    .map-container {
      height: 400px;
      width: 100%;
    }
    .place-card .map-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1;
    }
    .social-post {
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .social-post:hover {
      transform: translateY(-5px);
    }
    
    .post-image {
      border-radius: 8px;
      overflow: hidden;
    }
    
    .post-content {
      font-size: 1.1rem;
      line-height: 1.6;
    }
    
    .post-stats {
      color: #666;
      font-size: 0.9rem;
    }
    
    .post-stats i {
      margin-right: 4px;
    }
    
    .comment-content {
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 12px;
      margin-left: 8px;
    }
    
    .comment-content p {
      font-size: 0.9rem;
      margin: 0;
    }
    
    /* Add these new styles for place cards */
    .place-card {
      height: 100%;
      transition: transform 0.2s, box-shadow 0.2s;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .place-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .place-card .card-body {
      padding: 1.5rem;
    }

    .place-card .card-title {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: #2c3e50;
      font-weight: 600;
    }

    .place-card .rating-badge {
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
      margin-bottom: 0.8rem;
    }

    .place-card .location-info {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.8rem;
    }

    .place-card .reasoning {
      font-size: 0.95rem;
      color: #495057;
      margin-bottom: 1.2rem;
      line-height: 1.5;
      font-style: italic;
    }

    .place-card .card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }

    .place-card .btn-map {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .place-card .btn-map i {
      font-size: 1rem;
    }

    .place-card .weather-info {
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      padding: 0.8rem;
      margin-bottom: 1rem;
    }

    .place-card .weather-info p {
      margin-bottom: 0.3rem;
      font-size: 0.9rem;
    }

    .place-card .weather-info i {
      margin-right: 0.5rem;
      color: #0d6efd;
    }

    /* Back to Top Button Styles */
    .back-to-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background-color: #1a472a;  /* Dark green color */
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .back-to-top:hover {
      background-color: #2d5a3f;  /* Slightly lighter green on hover */
      color: white;
      transform: translateY(-3px);
    }

    .back-to-top.show {
      opacity: 1;
      visibility: visible;
    }

    .back-to-top i {
      font-size: 20px;
    }

    /* Add these new styles for enhanced recommendations */
    .recommendations-header {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 2rem;
    }

    .recommendations-header h4 {
      color: white;
      margin-bottom: 0.5rem;
    }

    .recommendation-filters {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .filter-card {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 10px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .filter-card:hover {
      border-color: #1a472a;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(26, 71, 42, 0.2);
    }

    .filter-card label {
      font-weight: 600;
      color: #1a472a;
      margin-bottom: 0.5rem;
    }

    .filter-card .form-select {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }

    .filter-card .form-select:focus {
      border-color: #1a472a;
      box-shadow: 0 0 0 0.2rem rgba(26, 71, 42, 0.25);
    }

    .recommendations-container {
      min-height: 200px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .recommendation-placeholder {
      padding: 3rem;
    }

    .recommendation-placeholder i {
      color: #1a472a;
      opacity: 0.5;
    }

    /* Enhanced recommendation cards */
    .recommendation-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .recommendation-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border-color: #1a472a;
    }

    .recommendation-card .card-body {
      padding: 1.5rem;
    }

    .recommendation-card .card-title {
      color: #1a472a;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .recommendation-badge {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      display: inline-block;
    }

    .recommendation-weather {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .recommendation-weather h6 {
      color: #1976d2;
      margin-bottom: 0.5rem;
    }

    .recommendation-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .recommendation-actions .btn {
      flex: 1;
      border-radius: 8px;
      padding: 0.75rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .recommendation-actions .btn-primary {
      background: #1a472a;
      border-color: #1a472a;
    }

    .recommendation-actions .btn-primary:hover {
      background: #2d5a3f;
      border-color: #2d5a3f;
      transform: translateY(-2px);
    }

    /* Loading animation */
    .recommendation-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
    }

    .recommendation-loading .spinner-border {
      color: #1a472a;
      width: 3rem;
      height: 3rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .recommendation-filters .row {
        margin: 0;
      }
      
      .filter-card {
        margin-bottom: 1rem;
      }
      
      .recommendation-actions {
        flex-direction: column;
      }
    }

    /* Interactive Map Navigation Styles */
    .interactive-map-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .map-navigation-card {
      background: white;
      border-radius: 20px;
      padding: 3rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 1px solid rgba(26, 71, 42, 0.1);
      transition: all 0.3s ease;
    }

    .map-navigation-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .map-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .feature-item:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(26, 71, 42, 0.3);
    }

    .feature-item i {
      font-size: 1.5rem;
      color: #ffd700;
    }

    .feature-item span {
      font-weight: 500;
      font-size: 1.1rem;
    }

    .map-preview {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(26, 71, 42, 0.2);
      transition: all 0.3s ease;
    }

    .map-preview:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 35px rgba(26, 71, 42, 0.3);
    }

    .map-preview i {
      color: #ffd700;
      margin-bottom: 1rem;
    }

    .map-preview h5 {
      color: white;
      margin-bottom: 1.5rem;
      font-weight: 600;
    }

    .map-preview .btn {
      background: #ffd700;
      border: none;
      color: #1a472a;
      font-weight: 600;
      padding: 1rem 2rem;
      border-radius: 25px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
    }

    .map-preview .btn:hover {
      background: #ffed4e;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
      color: #1a472a;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .map-navigation-card {
        padding: 2rem;
      }
      
      .map-features {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .map-preview {
        margin-top: 2rem;
      }
    }

    /* Enhanced Trip Planning Styles */
    .trip-planning-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .trip-tabs .nav-link {
      border: none;
      border-radius: 12px;
      margin-right: 0.5rem;
      padding: 1rem 1.5rem;
      font-weight: 600;
      color: #6c757d;
      transition: all 0.3s ease;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .trip-tabs .nav-link.active {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(26, 71, 42, 0.3);
    }

    .trip-tabs .nav-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .itinerary-builder-card,
    .reviews-section,
    .budget-calculator-card,
    .inquiry-card {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 1px solid rgba(26, 71, 42, 0.1);
      transition: all 0.3s ease;
    }

    .itinerary-builder-card:hover,
    .reviews-section:hover,
    .budget-calculator-card:hover,
    .inquiry-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .quick-tips-card,
    .review-stats-card,
    .budget-tips-card {
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 1px solid rgba(26, 71, 42, 0.1);
      height: fit-content;
    }

    .tips-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .tip-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .tip-item:hover {
      transform: translateX(5px);
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
    }

    .tip-item i {
      font-size: 1.2rem;
      min-width: 20px;
    }

    /* Feature Highlights for Budget Calculator - Removed */

    /* Review Styles */
    .review-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .review-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: #1a472a;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .reviewer-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .reviewer-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    .review-rating {
      display: flex;
      gap: 0.25rem;
    }

    .review-place {
      color: #1a472a;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .review-comment {
      color: #6c757d;
      line-height: 1.6;
      margin: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .stat-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1a472a;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #6c757d;
      font-weight: 500;
    }

    .rating-input .stars {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .star-rating {
      font-size: 1.5rem;
      color: #dee2e6;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .star-rating:hover,
    .star-rating.active {
      color: #ffd700;
      transform: scale(1.1);
    }

    /* Budget Calculator Styles - Removed */

    /* Form Enhancements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 600;
      color: #1a472a;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-control,
    .form-select {
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #1a472a;
      box-shadow: 0 0 0 0.2rem rgba(26, 71, 42, 0.25);
      transform: translateY(-2px);
    }

    .btn-primary-custom {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.75rem 2rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary-custom:hover {
      background: linear-gradient(135deg, #2d5a3f, #1a472a);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(26, 71, 42, 0.3);
      color: white;
    }

    /* Itinerary Display Styles */
    .itinerary-day {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid #1a472a;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .itinerary-day:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .itinerary-day h6 {
      color: #1a472a;
      font-weight: 600;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .itinerary-day h6 i {
      color: #2d5a3f;
    }

    .itinerary-place {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }

    .itinerary-place:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }

    .itinerary-place:last-child {
      margin-bottom: 0;
    }

    .place-time {
      background: #1a472a;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 60px;
      text-align: center;
    }

    .place-details {
      flex: 1;
    }

    .place-actions {
      display: flex;
      gap: 0.5rem;
    }

    .ai-insight {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      padding: 0.5rem;
      border-radius: 8px;
      border-left: 3px solid #2196f3;
    }

    .ai-insight i {
      margin-right: 0.5rem;
    }

    .day-summary {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border-left: 4px solid #ffc107;
    }

    .day-summary h6 {
      color: #856404;
      margin-bottom: 0.5rem;
    }

    .day-summary ul {
      padding-left: 1rem;
    }

    .day-summary li {
      margin-bottom: 0.25rem;
    }

    .day-summary li:last-child {
      margin-bottom: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .trip-tabs .nav-link {
        margin-bottom: 0.5rem;
        margin-right: 0;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .budget-categories {
        padding: 1rem;
      }
      
      .itinerary-builder-card,
      .reviews-section,
      .budget-calculator-card,
      .inquiry-card {
        padding: 1.5rem;
      }
    }

    /* Budget Calculator Modal Styles - Removed */

    /* Review Styles */

    .modal-footer .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* Enhanced Itinerary Loading Animation */
    .itinerary-loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .loading-animation {
      margin-bottom: 2rem;
    }

    .loading-spinner {
      position: relative;
      width: 80px;
      height: 80px;
    }

    .spinner-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 4px solid transparent;
      border-top: 4px solid #1a472a;
      border-radius: 50%;
      animation: spin 1.5s linear infinite;
    }

    .spinner-ring:nth-child(2) {
      width: 60px;
      height: 60px;
      top: 10px;
      left: 10px;
      border-top-color: #2d5a3f;
      animation-delay: 0.5s;
    }

    .spinner-ring:nth-child(3) {
      width: 40px;
      height: 40px;
      top: 20px;
      left: 20px;
      border-top-color: #28a745;
      animation-delay: 1s;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-content {
      text-align: center;
      max-width: 500px;
    }

    .loading-title {
      color: #1a472a;
      font-weight: 600;
      margin-bottom: 2rem;
      font-size: 1.5rem;
    }

    .loading-title i {
      color: #ffd700;
      margin-right: 0.5rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .loading-steps {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .loading-step {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      opacity: 0.5;
      transform: translateX(-20px);
    }

    .loading-step.active {
      opacity: 1;
      transform: translateX(0);
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      box-shadow: 0 5px 15px rgba(26, 71, 42, 0.3);
    }

    .loading-step i {
      font-size: 1.2rem;
      min-width: 20px;
      color: #1a472a;
    }

    .loading-step.active i {
      color: #ffd700;
    }

    .loading-step span {
      font-weight: 500;
    }

    .loading-progress {
      width: 100%;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1a472a, #2d5a3f, #28a745);
      border-radius: 4px;
      width: 0%;
      transition: width 0.5s ease;
      animation: progress 3s ease-in-out infinite;
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    /* Responsive adjustments for loading */
    @media (max-width: 768px) {
      .itinerary-loading-container {
        padding: 2rem 1rem;
      }
      
      .loading-title {
        font-size: 1.25rem;
      }
      
      .loading-steps {
        gap: 0.75rem;
      }
      
      .loading-step {
        padding: 0.75rem;
        font-size: 0.9rem;
      }
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    .loading-success {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      animation: successPulse 1s ease-in-out;
    }

    @keyframes successPulse {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .loading-title.text-success {
      color: #28a745 !important;
    }

    .loading-title.text-success i {
      color: #28a745 !important;
      animation: none;
    }

    /* Enhanced Button Styles */
    .btn-map {
      transition: all 0.3s ease;
      border-radius: 8px;
      font-weight: 500;
    }

    .btn-map:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-primary-custom {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.75rem 2rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary-custom:hover {
      background: linear-gradient(135deg, #2d5a3f, #1a472a);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(26, 71, 42, 0.3);
      color: white;
    }

    .btn-primary-custom:active {
      transform: translateY(0);
    }

    .btn-primary-custom:disabled {
      background: #6c757d;
      transform: none;
      box-shadow: none;
      cursor: not-allowed;
    }

    /* Loading Button Styles */
    .btn-loading {
      position: relative;
      color: transparent !important;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Success Alert Styles */
    .alert-success {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      border: 1px solid #c3e6cb;
      color: #155724;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Enhanced Card Hover Effects */
    .place-card:hover .btn-map {
      background-color: #1a472a;
      border-color: #1a472a;
      color: white;
    }

    .recommendation-card:hover .btn {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Category Filtering Styles */
    .place-card-wrapper {
      transition: all 0.3s ease;
    }

    .place-card-wrapper.animate__fadeIn {
      animation-duration: 0.5s;
    }

    .place-card-wrapper[style*="display: none"] {
      animation: none;
    }

    /* Enhanced Category Filter Styles */
    #categoryFilter {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(26, 71, 42, 0.3);
      transition: all 0.3s ease;
      min-width: 200px;
    }

    #categoryFilter:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(26, 71, 42, 0.4);
    }

    #categoryFilter:focus {
      box-shadow: 0 0 0 0.2rem rgba(26, 71, 42, 0.25);
    }

    #categoryFilter option {
      background: white;
      color: #1a472a;
      font-weight: 500;
    }

    /* Place Count Display */
    #place-count {
      margin-top: 0.5rem;
      font-weight: 500;
    }

    #place-count small {
      background: rgba(26, 71, 42, 0.1);
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      color: #1a472a;
    }

    /* Category Badge Styles */
    .category-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(26, 71, 42, 0.9);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 2;
    }

    /* Enhanced Place Card Styles */
    .place-card {
      position: relative;
      overflow: hidden;
    }

    .place-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(26, 71, 42, 0.1), rgba(45, 90, 63, 0.1));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1;
    }

    .place-card:hover::before {
      opacity: 1;
    }

    .place-card .card-body {
      position: relative;
      z-index: 2;
    }

    /* Map Modal Enhancements */
    .map-modal .modal-content {
      border-radius: 15px;
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .map-modal .modal-header {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: white;
      border-radius: 15px 15px 0 0;
    }

    .map-modal .modal-title {
      color: white;
      font-weight: 600;
    }

    /* Enhanced Form Controls */
    .form-control:focus,
    .form-select:focus {
      border-color: #1a472a;
      box-shadow: 0 0 0 0.2rem rgba(26, 71, 42, 0.25);
      transform: translateY(-2px);
    }

    /* Loading State Improvements */
    .recommendation-loading {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 15px;
      padding: 2rem;
    }

    .recommendation-loading .spinner-border {
      color: #1a472a;
      width: 3rem;
      height: 3rem;
    }

    /* Enhanced Recommendation Cards */
    .recommendation-card {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .recommendation-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border-color: #1a472a;
    }

    .recommendation-actions .btn {
      transition: all 0.3s ease;
      border-radius: 8px;
      font-weight: 500;
    }

    .recommendation-actions .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Favorited Button State */
    .btn.favorited {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }

    .btn.favorited:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
      .btn-primary-custom {
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
      }
      
      .recommendation-actions {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .recommendation-actions .btn {
        width: 100%;
      }
    }

    /* Place Card Image and Badge Improvements */
    .place-card {
      position: relative;
      overflow: hidden;
      min-height: 350px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .place-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      display: block;
    }
    .category-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(26, 71, 42, 0.95);
      color: #fff;
      padding: 0.35rem 0.9rem;
      border-radius: 16px;
      font-size: 0.85rem;
      font-weight: 700;
      z-index: 3;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .place-card .card-body {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 1.5rem;
      position: relative;
      z-index: 2;
      background: #fff;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }
    .place-card .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #1a472a;
      margin-bottom: 0.5rem;
      margin-top: 0.5rem;
      text-shadow: 0 2px 8px rgba(0,0,0,0.08), 0 1px 0 #fff;
      letter-spacing: 0.2px;
      background: rgba(255,255,255,0.85);
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 6px;
      max-width: 100%;
      overflow-wrap: break-word;
    }
    .place-card .card-text {
      color: #495057;
      font-size: 1rem;
      margin-bottom: 0.8rem;
      min-height: 48px;
    }

    /* Default image style */
    .default-place-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #e9ecef url('https://via.placeholder.com/400x200?text=No+Image') center center no-repeat;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      display: block;
    }

    @media (max-width: 768px) {
      .place-card img, .default-place-img {
        height: 150px;
      }
    }

    .calendar-container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .calendar-header { text-align: center; padding: 10px; background: #1a472a; color: white; border-radius: 5px 5px 0 0; display: flex; align-items: center; justify-content: space-between; }
    .calendar-title { flex: 1; font-size: 1.5rem; font-weight: 600; }
    .calendar-nav-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0 1rem; transition: color 0.2s; }
    .calendar-nav-btn:hover { color: #ffd700; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: #6c757d; padding: 10px 0; border-bottom: 1px solid #dee2e6; }
    .calendar-grid { min-height: 240px; display: grid; grid-template-columns: repeat(7, 1fr); }
    .calendar-cell {
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s, box-shadow 0.2s, color 0.2s;
      padding: 8px 0;
      margin: 2px;
      text-align: center;
      position: relative;
      font-weight: 500;
    }
    .calendar-cell:hover, .calendar-cell:focus {
      background: #e3f2fd;
      color: #1a472a;
      box-shadow: 0 2px 8px rgba(26,71,42,0.08);
      z-index: 2;
    }
    .calendar-cell.selected {
      background: linear-gradient(135deg, #1a472a, #2d5a3f);
      color: #fff;
      font-weight: 700;
      box-shadow: 0 4px 16px rgba(26,71,42,0.15);
    }
    .calendar-cell.event-day:not(.selected) {
      background: #fffbe6;
      border: 1px solid #ffd700;
    }
    .calendar-cell.today {
      border: 2px solid #1a472a;
    }
    .calendar-cell .event-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      background: #ffd700;
      border-radius: 50%;
      margin-left: 4px;
      vertical-align: middle;
    }
  </style>
  <!-- Add Font Awesome in the head section -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
  <!-- Messages Section -->
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-custom sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="{% url 'core:home' %}">South India Tourism</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="{% url 'core:home' %}">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'core:home' %}#destinations">Destinations</a></li>
          <!-- <li class="nav-item"><a class="nav-link" href="{% url 'core:home' %}#">Packages</a></li> -->
          <li class="nav-item"><a class="nav-link" href="{% url 'core:home' %}#contact">Contact</a></li>
          {% if user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{% url 'core:my_favorites' %}">My Favorites</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'core:profile' %}">Profile</a></li>
            <li class="nav-item">
              <form action="{% url 'logout' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-light nav-btn">Logout</button>
              </form>
            </li>
          {% else %}
            <li class="nav-item">
              <a href="{% url 'login' %}" class="btn btn-light nav-btn">Login</a>
            </li>
            <li class="nav-item">
              <a href="{% url 'signup' %}" class="btn btn-light nav-btn">Sign Up</a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section p-0">
    <div id="karnatakaHeroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="4000">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="https://images.unsplash.com/photo-1609766857041-ed453de276a3?auto=format&fit=crop&w=1920&q=80" class="d-block w-100 hero-img" alt="Hampi Stone Chariot">
          <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-3">
            <h2 class="fw-bold">Hampi Stone Chariot</h2>
            <p>Step back in time at the majestic UNESCO World Heritage Site.</p>
          </div>
        </div>
        <div class="carousel-item">
          <img src="https://images.unsplash.com/photo-1590766938236-814a8999335f?auto=format&fit=crop&w=1920&q=80" class="d-block w-100 hero-img" alt="Mysore Palace">
          <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-3">
            <h2 class="fw-bold">Mysore Palace</h2>
            <p>Witness the grandeur of one of India's most magnificent royal palaces.</p>
          </div>
        </div>
        <div class="carousel-item">
          <img src="https://images.unsplash.com/photo-1622327582215-63d415417852?auto=format&fit=crop&w=1920&q=80" class="d-block w-100 hero-img" alt="Jog Falls">
          <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-3">
            <h2 class="fw-bold">Jog Falls</h2>
            <p>Be mesmerized by one of the highest plunge waterfalls in India.</p>
          </div>
        </div>
        <div class="carousel-item">
          <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1920&q=80" class="d-block w-100 hero-img" alt="Coorg Hills">
          <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-3">
            <h2 class="fw-bold">Coorg Hills</h2>
            <p>Relax in the lush coffee estates and misty hills of Coorg.</p>
          </div>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#karnatakaHeroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#karnatakaHeroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
      <div style="position:absolute;inset:0;background:linear-gradient(rgba(0,0,0,0.3),rgba(0,0,0,0.6));z-index:2;"></div>
      <div class="hero-overlay d-flex flex-column align-items-center justify-content-center text-center">
        <h1 class="hero-title text-white animate__animated animate__fadeInDown mb-3" style="font-size:3.5rem;font-weight:700;text-shadow:0 3px 10px rgba(0,0,0,0.6);">Discover {{ state.name }}</h1>
        <p class="hero-subtitle text-white animate__animated animate__fadeInUp animate__delay-1s mb-4" style="font-size:1.5rem;text-shadow:0 2px 8px rgba(0,0,0,0.5);">{{ state.tagline|default:"One State, Many Worlds" }}</p>
        <div class="d-flex flex-column flex-md-row gap-3 animate__animated animate__fadeInUp animate__delay-2s align-items-center justify-content-center">
            {% include 'core/partials/favorite_button.html' %}
            <a href="#booking" class="btn btn-lg btn-primary ms-2">Plan Your Trip</a>
        </div>
      </div>
    </div> <!-- #karnatakaHeroCarousel -->
  </section>

  <!-- Secondary Navigation -->
  <nav class="secondary-nav sticky-top">
    <div class="container">
      <ul class="nav justify-content-center">
        <li class="nav-item"><a class="nav-link" href="#overview">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="#places">Places to Visit</a></li>
        <li class="nav-item"><a class="nav-link" href="#interactive-map">Interactive Map</a></li>
        <li class="nav-item"><a class="nav-link" href="#cuisine">Cuisine</a></li>
        <li class="nav-item"><a class="nav-link" href="#events">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="#reviews">Traveler Reviews</a></li>
        <li class="nav-item"><a class="nav-link" href="#safety">Safety Tips</a></li>
        <li class="nav-item"><a class="nav-link" href="#booking">Plan / Inquiry</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <!-- State Details Section -->
    <section class="state-details py-6" id="overview">
      <div class="container">
        <ul class="nav nav-tabs state-tabs mb-4" id="stateTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview-tab-content" role="tab" aria-controls="overview-tab-content" aria-selected="true">Overview</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="history-tab" data-bs-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">History</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="culture-tab" data-bs-toggle="tab" href="#culture" role="tab" aria-controls="culture" aria-selected="false">Culture</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="climate-tab" data-bs-toggle="tab" href="#climate" role="tab" aria-controls="climate" aria-selected="false">Climate</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="best-time-tab" data-bs-toggle="tab" href="#best-time" role="tab" aria-controls="best-time" aria-selected="false">Best Time to Visit</a>
          </li>
        </ul>

        <div class="tab-content" id="stateTabsContent">
          <div class="tab-pane fade show active" id="overview-tab-content" role="tabpanel" aria-labelledby="overview-tab">
            <h2 class="section-title">{{ state.description }}</h2>
            <p class="section-content">
              Karnataka, located in the southern part of India, is known for its rich heritage, magnificent palaces, and diverse landscapes. The state is home to ancient temples, beautiful hill stations, and modern cities. From the historic ruins of Hampi to the royal Mysore Palace, from the tech hub of Bengaluru to the coffee estates of Coorg, Karnataka offers a perfect blend of tradition and modernity.
            </p>
          </div>
          <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
            <h2 class="section-title">History</h2>
            <p class="section-content">{{ state.history }}</p>
          </div>
          <div class="tab-pane fade" id="culture" role="tabpanel" aria-labelledby="culture-tab">
            <h2 class="section-title">Culture</h2>
            <p class="section-content">{{ state.culture }}</p>
            <h4 class="mt-4">Cultural Safety Tips</h4>
            <ul class="safety-tips-list">
              {% for tip in state.cultural_safety_tips %}
                <li>{{ tip }}</li>
              {% empty %}
                <li>No specific cultural safety tips available.</li>
              {% endfor %}
            </ul>
          </div>
          <div class="tab-pane fade" id="climate" role="tabpanel" aria-labelledby="climate-tab">
            <h2 class="section-title">Climate</h2>
            <p class="section-content">{{ state.climate }}</p>
          </div>
          <div class="tab-pane fade" id="best-time" role="tabpanel" aria-labelledby="best-time-tab">
            <h2 class="section-title">Best Time to Visit</h2>
            <p class="section-content">{{ state.best_time_to_visit }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Places to Visit -->
    <section class="places-section py-6 bg-light" id="places">
      <div class="container">
        <h2 class="section-title text-center mb-5">Places to Visit</h2>
        
        <!-- Enhanced AI-Powered Recommendations -->
        <div class="mb-5">
          <div class="recommendations-header text-center mb-4">
            <h4 class="mb-3">
              <i class="fas fa-magic"></i> 
              AI-Powered Smart Recommendations
            </h4>
            <p class="text-muted">Get personalized suggestions based on your preferences and current location</p>
          </div>
          
          <!-- Interactive Filters -->
          <div class="recommendation-filters mb-4">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="filter-card">
                  <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Your Location
                  </label>
                  <select id="user-place" class="form-select">
                    <option value="">Select your current place</option>
                    {% for place_data in places_with_weather %}
                      <option value="{{ place_data.place.name }}" 
                              data-lat="{{ place_data.latitude }}" 
                              data-lng="{{ place_data.longitude }}">
                        {{ place_data.place.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="filter-card">
                  <label class="form-label">
                    <i class="fas fa-tag"></i> Interest Type
                  </label>
                  <select id="gemini-place-type" class="form-select">
                    <option value="tourist_attraction">üèõÔ∏è Tourist Attractions</option>
                    <option value="hindu_temple">üïç Temples</option>
                    <option value="park">üèîÔ∏è Hill Stations</option>
                    <option value="beach">üèñÔ∏è Beaches</option>
                    <option value="museum">üèõÔ∏è Museums</option>
                    <option value="restaurant">üçΩÔ∏è Restaurants</option>
                    <option value="shopping_mall">üõçÔ∏è Shopping</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="filter-card">
                  <label class="form-label">
                    <i class="fas fa-wallet"></i> Budget Range
                  </label>
                  <select id="budget" class="form-select">
                    <option value="low">üí∞ Budget Friendly</option>
                    <option value="medium">üí≥ Moderate</option>
                    <option value="high">üíé Premium</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="filter-card">
                  <label class="form-label">
                    <i class="fas fa-clock"></i> Duration
                  </label>
                  <select id="duration" class="form-select">
                    <option value="short">‚è∞ Quick Visit (1-2 hours)</option>
                    <option value="medium">üïê Half Day (3-4 hours)</option>
                    <option value="long">üåÖ Full Day (6+ hours)</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="text-center mt-4">
              <button class="btn btn-primary btn-lg me-3" onclick="fetchGeminiRecommendations()">
                <i class="fas fa-magic"></i> Get Smart Recommendations
              </button>
              <button class="btn btn-outline-secondary" onclick="clearRecommendations()">
                <i class="fas fa-refresh"></i> Clear Results
              </button>
            </div>
          </div>
          
          <!-- Loading and Results Container -->
          <div id="gemini-recommended-places" class="recommendations-container">
            <div class="text-center py-5">
              <div class="recommendation-placeholder">
                <i class="fas fa-compass fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Ready to Discover?</h5>
                <p class="text-muted">Select your preferences above and get personalized recommendations</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Category Filter -->
        <div class="mb-4 text-center">
          <label for="categoryFilter" class="form-label">Filter by Category:</label>
          <select id="categoryFilter" class="form-select w-auto d-inline-block mx-auto" onchange="filterPlacesByCategory()">
            <option value="all">All Categories</option>
            <option value="religious">üïç Religious/Temples</option>
            <option value="natural">üèîÔ∏è Natural/Beaches</option>
            <option value="historical">üèõÔ∏è Historical</option>
            <option value="cultural">üé≠ Cultural</option>
            <option value="adventure">üèÉ Adventure</option>
            <option value="entertainment">üé™ Entertainment</option>
          </select>
        </div>

        <!-- Places List -->
        <div class="row" id="places-list">
          {% for place_data in places_with_weather %}
            <div class="col-md-6 col-lg-4 mb-4 place-card-wrapper" data-category="{{ place_data.place.category|lower }}">
              <div class="card place-card">
                <!-- Category Badge always on top -->
                <div class="category-badge">
                  {% if place_data.place.category == 'religious' %}
                    üïç Temple
                  {% elif place_data.place.category == 'natural' %}
                    üèîÔ∏è Natural
                  {% elif place_data.place.category == 'historical' %}
                    üèõÔ∏è Historical
                  {% elif place_data.place.category == 'cultural' %}
                    üé≠ Cultural
                  {% elif place_data.place.category == 'adventure' %}
                    üèÉ Adventure
                  {% else %}
                    üé™ {{ place_data.place.category|title }}
                  {% endif %}
                </div>
                {% if place_data.place.image %}
                  <img src="{{ place_data.place.image.url }}" class="card-img-top" alt="{{ place_data.place.name }}">
                {% else %}
                  <div class="default-place-img"></div>
                {% endif %}
                <div class="card-body">
                  <h5 class="card-title">{{ place_data.place.name }}</h5>
                  <p class="card-text">{{ place_data.place.description }}</p>
                  
                  <!-- Weather Information -->
                  {% if place_data.weather %}
                    <div class="weather-info mb-3">
                      <h6>Current Weather</h6>
                      <p><i class="fas fa-temperature-high"></i> Temperature: {{ place_data.weather.temperature }}¬∞C</p>
                      <p><i class="fas fa-cloud"></i> Condition: {{ place_data.weather.condition }}</p>
                    </div>
                  {% endif %}
                  
                  <!-- Action Buttons -->
                  <div class="card-actions">
                    <button class="btn btn-outline-primary btn-map" 
                            onclick="showPlaceOnMap({{ place_data.latitude }}, {{ place_data.longitude }}, '{{ place_data.place.name|escapejs }}')">
                      <i class="fas fa-map-marker-alt"></i> Show on Map
                    </button>
                    {% if user.is_authenticated %}
                      <form method="post" action="{% url 'core:add_favorite' place_data.place.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-secondary btn-sm">
                          <i class="far fa-heart"></i>
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="col-12 text-center">
              <p>No places found for this category.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Interactive Map Section -->
    <section class="interactive-map-section py-6" id="interactive-map">
      <div class="container">
        <div class="map-navigation-card">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="section-title mb-4">Interactive Map</h2>
              <p class="lead mb-4">Explore Karnataka with our advanced interactive map featuring real-time location search, route planning, and personalized recommendations.</p>
              <div class="map-features">
                <div class="feature-item">
                  <i class="fas fa-search"></i>
                  <span>Search nearby places</span>
                </div>
                <div class="feature-item">
                  <i class="fas fa-route"></i>
                  <span>Plan your routes</span>
                </div>
                <div class="feature-item">
                  <i class="fas fa-map-marker-alt"></i>
                  <span>Real-time location</span>
                </div>
                <div class="feature-item">
                  <i class="fas fa-star"></i>
                  <span>Save favorites</span>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-center">
              <div class="map-preview">
                <i class="fas fa-map-marked-alt fa-4x text-primary mb-3"></i>
                <h5>Ready to Explore?</h5>
                <a href="{% url 'core:map_view' %}" class="btn btn-primary btn-lg mt-3">
                  <i class="fas fa-map"></i> Open Interactive Map
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Local Cuisine and Dining Recommendations -->
    <section class="cuisine-section py-6" id="cuisine">
      <div class="container">
        <h2 class="section-title text-center mb-5">Local Cuisine and Dining Recommendations</h2>
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card cuisine-card h-100">
              <div class="card-body">
                <h4>Iconic Dishes</h4>
                <p>Indulge in Karnataka's culinary delights:</p>
                <ul>
                  {% for cuisine in state.cuisines.all %}
                    <li><strong>{{ cuisine.name }}:</strong> {{ cuisine.description }}</li>
                  {% empty %}
                    <li>No iconic dishes listed.</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card cuisine-card h-100">
              <div class="card-body">
                <h4>Top Restaurants</h4>
                {% for restaurant in state.restaurants.all %}
                  <div class="restaurant-item mb-3">
                    <h6>{{ restaurant.name }}</h6>
                    <p><strong>Specialty:</strong> {{ restaurant.specialty }}</p>
                    <p><strong>Average Cost:</strong> ‚Çπ{{ restaurant.average_cost }} per person.</p>
                  </div>
                {% empty %}
                  <p>No top restaurants listed.</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Events and Festivals -->
    <section class="events-section py-6 bg-light" id="events">
      <div class="container">
        <div class="calendar-container mb-5">
          <div class="calendar-header">
            <button id="calendarPrev" class="calendar-nav-btn" aria-label="Previous Month">&#8592;</button>
            <span class="calendar-title">Karnataka Events & Festivals - <span id="calendarMonthYear"></span></span>
            <button id="calendarNext" class="calendar-nav-btn" aria-label="Next Month">&#8594;</button>
          </div>
          <div class="calendar-days" id="calendarDays">
            <div class="calendar-day">Sun</div><div class="calendar-day">Mon</div><div class="calendar-day">Tue</div>
            <div class="calendar-day">Wed</div><div class="calendar-day">Thu</div><div class="calendar-day">Fri</div><div class="calendar-day">Sat</div>
          </div>
          <div class="calendar-grid" id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); background: #fff;"></div>
        </div>
        <div class="event-list" id="eventList">
          <h3>Events & Festivals</h3>
          <div id="eventPrompt" class="event-item"><p>Please select a date on the calendar to view events or festivals.</p></div>
        </div>
      </div>
      <style>
        .calendar-container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .calendar-header { text-align: center; padding: 10px; background: #007bff; color: white; border-radius: 5px 5px 0 0; display: flex; align-items: center; justify-content: space-between; }
        .calendar-title { flex: 1; font-size: 1.5rem; font-weight: 600; }
        .calendar-nav-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0 1rem; transition: color 0.2s; }
        .calendar-nav-btn:hover { color: #ffd700; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding: 10px; }
        .calendar-day { padding: 10px; border: 1px solid #ddd; background: #f8f9fa; font-weight: 600; }
        .calendar-grid { min-height: 120px; transition: all 0.3s; }
        .calendar-cell { padding: 12px 0; border: 1px solid #eee; text-align: center; cursor: pointer; position: relative; background: #fff; transition: background 0.2s; min-height: 40px; font-size: 1.1rem; }
        .calendar-cell.event-day { background: #e3f2fd; font-weight: bold; color: #007bff; border: 2px solid #007bff; }
        .calendar-cell.today { background: #ffe082; border: 2px solid #ffc107; }
        .calendar-cell:hover { background: #f1f8e9; }
        .calendar-cell.selected { background: #007bff; color: white; border: 2px solid #0056b3; }
        .event-list { margin-top: 20px; }
        .event-item { padding: 16px; border-bottom: 1px solid #eee; background: #fff; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .event-item h4 { margin: 0 0 6px 0; color: #333; font-size: 1.2rem; }
        .event-item p { margin: 4px 0; color: #666; }
        .event-item .event-date { font-weight: bold; color: #007bff; }
      </style>
      <script>
        // Karnataka Events & Festivals (hardcoded for calendar)
        const events = [
          { date: new Date('2025-03-29'), title: 'Ugadi', place: 'Throughout Karnataka', description: 'Kannada New Year celebrated with traditional foods and rituals.' },
          { date: new Date('2025-04-05'), title: 'Karaga Festival', place: 'Bengaluru', description: 'A centuries-old festival dedicated to Draupadi, celebrated with a grand procession.' },
          { date: new Date('2025-10-12'), title: 'Mysore Dasara', place: 'Mysore', description: 'Ten-day royal festival with processions, cultural events, and illuminated palaces.' },
          { date: new Date('2025-03-30'), title: 'Vairamudi Festival', place: 'Melukote', description: 'Religious festival where the deity is adorned with a diamond-studded crown.' },
          { date: new Date('2025-11-15'), title: 'Kambala', place: 'Coastal Karnataka', description: 'Traditional buffalo race held in the waterlogged fields of coastal Karnataka.' },
          { date: new Date('2025-11-12'), title: 'Deepavali', place: 'Throughout Karnataka', description: 'Festival of lights celebrated with fireworks and sweets.' }
        ];

        // Calendar rendering logic with navigation
        let currentMonth, currentYear, selectedDate = null;
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        function renderCalendar(month, year) {
          currentMonth = month;
          currentYear = year;
          const calendarGrid = document.getElementById('calendarGrid');
          const monthYear = document.getElementById('calendarMonthYear');
          monthYear.textContent = months[month] + ' ' + year;
          calendarGrid.innerHTML = '';
          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          // Fill blanks for first week
          for (let i = 0; i < firstDay; i++) {
            calendarGrid.innerHTML += '<div class="calendar-cell"></div>';
          }
          // Render days
          const today = new Date();
          for (let d = 1; d <= daysInMonth; d++) {
            const cellDate = new Date(year, month, d);
            const isToday = cellDate.toDateString() === today.toDateString();
            const hasEvent = events.some(ev => ev.date.toDateString() === cellDate.toDateString());
            const isSelected = selectedDate && cellDate.toDateString() === selectedDate.toDateString();
            calendarGrid.innerHTML += `<div class="calendar-cell${hasEvent ? ' event-day' : ''}${isToday ? ' today' : ''}${isSelected ? ' selected' : ''}" data-date="${cellDate.toISOString()}">${d}${hasEvent ? ' <span style=\"color:#007bff;font-size:1.1em;\">‚Ä¢</span>' : ''}</div>`;
          }
        }

        function renderEvents(selected = null) {
          const eventList = document.getElementById('eventList');
          let html = '<h3>Events & Festivals</h3>';
          if (!selected) {
            html += '<div id="eventPrompt" class="event-item"><p>Please select a date on the calendar to view events or festivals.</p></div>';
          } else {
            const filteredEvents = events.filter(ev => ev.date.toDateString() === selected.toDateString());
            if (filteredEvents.length === 0) {
              html += '<div class="event-item"><p>No events or festivals for this date.</p></div>';
            } else {
              filteredEvents.forEach(ev => {
                html += `<div class="event-item">
                  <h4>${ev.title} <span class="event-date">(${ev.date.toLocaleDateString('en-IN')})</span></h4>
                  <p><strong>Location:</strong> ${ev.place}</p>
                  <p>${ev.description}</p>
                </div>`;
              });
            }
          }
          eventList.innerHTML = html;
        }

        function prevMonth() {
          if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
          } else {
            currentMonth--;
          }
          selectedDate = null;
          renderCalendar(currentMonth, currentYear);
          renderEvents();
        }

        function nextMonth() {
          if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
          } else {
            currentMonth++;
          }
          selectedDate = null;
          renderCalendar(currentMonth, currentYear);
          renderEvents();
        }

        document.addEventListener('DOMContentLoaded', function() {
          const now = new Date();
          currentMonth = now.getMonth();
          currentYear = now.getFullYear();
          renderCalendar(currentMonth, currentYear);
          renderEvents();
          document.getElementById('calendarGrid').addEventListener('click', function(e) {
            if (e.target.classList.contains('calendar-cell') && e.target.dataset.date) {
              selectedDate = new Date(e.target.dataset.date);
              renderCalendar(currentMonth, currentYear);
              renderEvents(selectedDate);
            }
          });
          document.getElementById('calendarPrev').addEventListener('click', prevMonth);
          document.getElementById('calendarNext').addEventListener('click', nextMonth);
        });
      </script>
    </section>

    <!-- User-Generated Content and Social Proof -->
    <section class="ugc-section py-6 bg-light" id="ugc">
      <div class="container">
        <h2 class="section-title text-center mb-5">Traveler Stories</h2>
        <div class="row">
          <!-- Sample Social Media Posts -->
          <div class="col-md-6 mb-4">
            <div class="card social-post">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <img src="https://randomuser.me/api/portraits/women/44.jpg" class="rounded-circle me-3" width="50" height="50" alt="User Avatar">
                  <div>
                    <h6 class="mb-0">Sarah Johnson</h6>
                    <small class="text-muted">Travel Blogger</small>
                  </div>
                </div>
                <div class="post-image mb-3">
                  <img src="{% static 'core/images/tamil_nadu.jpg' %}" class="img-fluid rounded" alt="Tamil Nadu Temple">
                </div>
                <p class="post-content">Just visited the magnificent Hampi ruins! The ancient architecture and spiritual atmosphere are absolutely breathtaking. A must-visit destination in Karnataka! üèõÔ∏è‚ú®</p>
                <div class="post-stats mb-3">
                  <span><i class="fas fa-heart text-danger"></i> 2.4k</span>
                  <span class="ms-3"><i class="fas fa-comment"></i> 156</span>
                  <span class="ms-3"><i class="fas fa-share"></i> 89</span>
                </div>
                <div class="post-comments">
                  <div class="d-flex mb-2">
                    <img src="https://randomuser.me/api/portraits/men/32.jpg" class="rounded-circle me-2" width="32" height="32" alt="Commenter Avatar">
                    <div class="comment-content">
                      <small class="fw-bold">Rajesh Kumar</small>
                      <p class="mb-0">The temple is even more beautiful during the evening aarti ceremony! üåÖ</p>
                    </div>
                  </div>
                </div>
                <small class="text-muted">Posted 2 days ago</small>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="card social-post">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <img src="https://randomuser.me/api/portraits/men/67.jpg" class="rounded-circle me-3" width="50" height="50" alt="User Avatar">
                  <div>
                    <h6 class="mb-0">Michael Chen</h6>
                    <small class="text-muted">Photography Enthusiast</small>
                  </div>
                </div>
                <div class="post-image mb-3">
                  <img src="{% static 'core/images/tamil_nadu.jpg' %}" class="img-fluid rounded" alt="Ooty Hills">
                </div>
                <p class="post-content">Exploring the beautiful Nilgiri Hills in Ooty! The tea gardens and mountain views are absolutely stunning. Perfect weather for a morning trek! üèîÔ∏è‚òï</p>
                <div class="post-stats mb-3">
                  <span><i class="fas fa-heart text-danger"></i> 1.8k</span>
                  <span class="ms-3"><i class="fas fa-comment"></i> 98</span>
                  <span class="ms-3"><i class="fas fa-share"></i> 45</span>
                </div>
                <div class="post-comments">
                  <div class="d-flex mb-2">
                    <img src="https://randomuser.me/api/portraits/women/22.jpg" class="rounded-circle me-2" width="32" height="32" alt="Commenter Avatar">
                    <div class="comment-content">
                      <small class="fw-bold">Priya Sharma</small>
                      <p class="mb-0">Don't forget to try the local tea and homemade chocolates! üç´</p>
                    </div>
                  </div>
                </div>
                <small class="text-muted">Posted 1 week ago</small>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="card social-post">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <img src="https://randomuser.me/api/portraits/women/28.jpg" class="rounded-circle me-3" width="50" height="50" alt="User Avatar">
                  <div>
                    <h6 class="mb-0">Emma Wilson</h6>
                    <small class="text-muted">Food Blogger</small>
                  </div>
                </div>
                <div class="post-image mb-3">
                  <img src="{% static 'core/images/tamil_nadu.jpg' %}" class="img-fluid rounded" alt="Tamil Nadu Food">
                </div>
                <p class="post-content">Food heaven in Bengaluru! The authentic Karnataka cuisine is a flavor explosion. From spicy curries to crispy dosas, every bite is a delight! üçõ‚ú®</p>
                <div class="post-stats mb-3">
                  <span><i class="fas fa-heart text-danger"></i> 3.2k</span>
                  <span class="ms-3"><i class="fas fa-comment"></i> 245</span>
                  <span class="ms-3"><i class="fas fa-share"></i> 167</span>
                </div>
                <div class="post-comments">
                  <div class="d-flex mb-2">
                    <img src="https://randomuser.me/api/portraits/men/45.jpg" class="rounded-circle me-2" width="32" height="32" alt="Commenter Avatar">
                    <div class="comment-content">
                      <small class="fw-bold">Arun Kumar</small>
                      <p class="mb-0">Try the filter coffee next time! It's a must-have experience ‚òï</p>
                    </div>
                  </div>
                </div>
                <small class="text-muted">Posted 3 days ago</small>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="card social-post">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <img src="https://randomuser.me/api/portraits/men/89.jpg" class="rounded-circle me-3" width="50" height="50" alt="User Avatar">
                  <div>
                    <h6 class="mb-0">David Park</h6>
                    <small class="text-muted">Adventure Seeker</small>
                  </div>
                </div>
                <div class="post-image mb-3">
                  <img src="{% static 'core/images/tamil_nadu.jpg' %}" class="img-fluid rounded" alt="Kanyakumari">
                </div>
                <p class="post-content">Witnessed the magical sunrise at Kanyakumari - where three oceans meet! The Vivekananda Rock Memorial is a spiritual experience. üåÖüåä</p>
                <div class="post-stats mb-3">
                  <span><i class="fas fa-heart text-danger"></i> 2.9k</span>
                  <span class="ms-3"><i class="fas fa-comment"></i> 178</span>
                  <span class="ms-3"><i class="fas fa-share"></i> 92</span>
                </div>
                <div class="post-comments">
                  <div class="d-flex mb-2">
                    <img src="https://randomuser.me/api/portraits/women/56.jpg" class="rounded-circle me-2" width="32" height="32" alt="Commenter Avatar">
                    <div class="comment-content">
                      <small class="fw-bold">Lakshmi Devi</small>
                      <p class="mb-0">The sunset view is equally mesmerizing! üåÖ</p>
                    </div>
                  </div>
                </div>
                <small class="text-muted">Posted 5 days ago</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Travel Safety Tips -->
    <section class="safety-section py-6" id="safety">
      <div class="container">
        <h2 class="section-title text-center mb-5">Travel Safety Tips</h2>
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card safety-card h-100">
              <div class="card-body">
                <h4>General Safety Tips</h4>
                <ul class="safety-tips-list">
                  <li>Be cautious of pickpockets in crowded areas like markets and temples.</li>
                  <li>Keep your belongings secure while visiting popular tourist spots.</li>
                  <li>Follow local customs and dress codes when visiting religious sites.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card safety-card h-100">
              <div class="card-body">
                <h4>Emergency Contacts</h4>
                <ul class="safety-tips-list">
                  <li><strong>Police:</strong> 100</li>
                  <li><strong>Tourist Helpline:</strong> 1800-425-31111</li>
                  <li><strong>Apollo Hospital (Bengaluru):</strong> +91-80-7179-1090</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Enhanced Plan Your Trip Section -->
    <section class="trip-planning-section py-6 bg-light" id="booking">
      <div class="container">
        <h2 class="section-title text-center mb-5">
          <i class="fas fa-route"></i> Plan Your Perfect Trip
        </h2>
        
        <!-- Trip Planning Tabs -->
        <ul class="nav nav-tabs trip-tabs mb-4" id="tripTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="itinerary-tab" data-bs-toggle="tab" data-bs-target="#itinerary" type="button" role="tab">
              <i class="fas fa-calendar-alt"></i> Itinerary Builder
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
              <i class="fas fa-star"></i> Traveler Reviews
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking-form" type="button" role="tab">
              <i class="fas fa-envelope"></i> Custom Inquiry
            </button>
          </li>
        </ul>

        <div class="tab-content" id="tripTabsContent">
          <!-- Itinerary Builder Tab -->
          <div class="tab-pane fade show active" id="itinerary" role="tabpanel">
            <div class="row">
              <div class="col-lg-8">
                <div class="itinerary-builder-card">
                  <h4 class="mb-4">
                    <i class="fas fa-map-marked-alt"></i> Create Your Custom Itinerary
                  </h4>
                  
                  <!-- Trip Details Form -->
                  <form id="itineraryForm" class="mb-4">
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-calendar"></i> Trip Duration
                          </label>
                          <select class="form-select" id="tripDuration">
                            <option value="1">1 Day</option>
                            <option value="2">2 Days</option>
                            <option value="3" selected>3 Days</option>
                            <option value="5">5 Days</option>
                            <option value="7">1 Week</option>
                            <option value="10">10 Days</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-users"></i> Travel Style
                          </label>
                          <select class="form-select" id="travelStyle">
                            <option value="adventure">Adventure</option>
                            <option value="cultural">Cultural</option>
                            <option value="relaxation">Relaxation</option>
                            <option value="luxury">Luxury</option>
                            <option value="budget">Budget</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-map-marker-alt"></i> Starting Point
                          </label>
                          <input type="text" class="form-control" id="startingPoint" placeholder="e.g., Bengaluru Airport">
                        </div>
                      </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary-custom" onclick="generateItinerary()">
                      <i class="fas fa-magic"></i> Generate Itinerary
                    </button>
                  </form>
                  
                  <!-- Generated Itinerary Display -->
                  <div id="generatedItinerary" class="d-none">
                    <h5 class="mb-3">Your Custom Itinerary</h5>
                    <div id="itineraryDays"></div>
                    <div class="mt-3">
                      <button class="btn btn-success me-2" onclick="saveItinerary()">
                        <i class="fas fa-save"></i> Save Itinerary
                      </button>
                      <button class="btn btn-info me-2" onclick="exportItinerary()">
                        <i class="fas fa-download"></i> Export PDF
                      </button>
                      <button class="btn btn-secondary" onclick="resetItinerary()">
                        <i class="fas fa-refresh"></i> Reset
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-4">
                <div class="quick-tips-card">
                  <h5 class="mb-3">
                    <i class="fas fa-lightbulb"></i> Planning Tips
                  </h5>
                  <div class="tips-list">
                    <div class="tip-item">
                      <i class="fas fa-clock text-primary"></i>
                      <span>Best time to visit: {{ state.best_time_to_visit|default:"October to March" }}</span>
                    </div>
                    <div class="tip-item">
                      <i class="fas fa-thermometer-half text-warning"></i>
                      <span>Weather: {{ state.climate|default:"Tropical climate with monsoon rains" }}</span>
                    </div>
                    <div class="tip-item">
                      <i class="fas fa-money-bill-wave text-success"></i>
                      <span>Budget: ‚Çπ2000-5000 per day for moderate travel</span>
                    </div>
                    <div class="tip-item">
                      <i class="fas fa-bus text-info"></i>
                      <span>Transport: Well-connected by road, rail, and air</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Traveler Reviews Tab -->
          <div class="tab-pane fade" id="reviews" role="tabpanel">
            <div class="row">
              <div class="col-lg-8">
                <div class="reviews-section">
                  <h4 class="mb-4">
                    <i class="fas fa-comments"></i> What Travelers Say
                  </h4>
                  
                  <!-- Review Filters -->
                  <div class="review-filters mb-4">
                    <div class="row">
                      <div class="col-md-4">
                        <select class="form-select" id="reviewFilter">
                          <option value="all">All Reviews</option>
                          <option value="5">5 Star Reviews</option>
                          <option value="4">4+ Star Reviews</option>
                          <option value="3">3+ Star Reviews</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <select class="form-select" id="placeFilter">
                          <option value="all">All Places</option>
                          {% for place_data in places_with_weather %}
                            <option value="{{ place_data.place.id }}">{{ place_data.place.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-md-4">
                        <button class="btn btn-primary-custom w-100" onclick="filterReviews()">
                          <i class="fas fa-filter"></i> Filter Reviews
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Reviews Display -->
                  <div id="reviewsContainer">
                    {% with has_reviews=False review_count=0 %}
                      {% for place_data in places_with_weather %}
                        {% for review in place_data.place.reviews.all %}
                          {% if not has_reviews %}{% with has_reviews=True %}{% endwith %}{% endif %}
                          {% with review_count=review_count|add:1 %}{% endwith %}
                          <div class="review-card mb-3" data-rating="{{ review.rating }}" data-place="{{ place_data.place.id }}" style="display: {% if review_count > 10 %}none{% else %}block{% endif %};">
                            <div class="review-header">
                              <div class="reviewer-info">
                                <img src="https://ui-avatars.com/api/?name={{ review.user.username }}&background=1a472a&color=fff" 
                                     class="reviewer-avatar" alt="{{ review.user.username }}">
                                <div>
                                  <h6 class="mb-0">{{ review.user.username }}</h6>
                                  <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                                </div>
                              </div>
                              <div class="review-rating">
                                {% for i in "12345" %}
                                  <i class="fas fa-star {% if forloop.counter <= review.rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                {% endfor %}
                              </div>
                            </div>
                            <div class="review-content">
                              <h6 class="review-place">{{ place_data.place.name }}</h6>
                              <p class="review-comment">{{ review.comment }}</p>
                            </div>
                          </div>
                        {% endfor %}
                      {% endfor %}
                      {% if not has_reviews %}
                        <div id="no-reviews-message" class="text-center py-4">
                          <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                          <p class="text-muted">No reviews yet for this state.</p>
                        </div>
                      {% endif %}
                      {% if review_count > 10 %}
                        <div class="text-center mb-3">
                          <button id="showMoreReviewsBtn" class="btn btn-outline-primary btn-sm">Show More Reviews</button>
                        </div>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>
              
              <div class="col-lg-4">
                <div class="review-stats-card">
                  <h5 class="mb-3">
                    <i class="fas fa-chart-bar"></i> Review Statistics
                  </h5>
                  <div class="stats-grid">
                    <div class="stat-item">
                      <div class="stat-number">{{ state.reviews.count }}</div>
                      <div class="stat-label">Total Reviews</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-number">
                        {% if state.reviews.count > 0 %}
                          4.2
                        {% else %}
                          0
                        {% endif %}
                      </div>
                      <div class="stat-label">Average Rating</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-number">{{ places_with_weather|length }}</div>
                      <div class="stat-label">Places Reviewed</div>
                    </div>
                  </div>
                  
                  <!-- Add Review Section -->
                  {% if user.is_authenticated %}
                    <div class="add-review-section mt-4">
                      <h6 class="mb-3">Share Your Experience</h6>
                      <form id="addReviewForm">
                        <div class="form-group mb-2">
                          <select class="form-select" id="reviewPlace" required>
                            <option value="">Select a place</option>
                            {% for place_data in places_with_weather %}
                              <option value="{{ place_data.place.id }}">{{ place_data.place.name }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="form-group mb-2">
                          <div class="rating-input">
                            <label class="form-label">Rating:</label>
                            <div class="stars">
                              {% for i in "12345" %}
                                <i class="fas fa-star star-rating" data-rating="{{ forloop.counter }}"></i>
                              {% endfor %}
                            </div>
                          </div>
                        </div>
                        <div class="form-group mb-2">
                          <textarea class="form-control" id="reviewComment" rows="3" placeholder="Share your experience..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary-custom w-100">
                          <i class="fas fa-paper-plane"></i> Submit Review
                        </button>
                      </form>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Budget Calculator Tab -->
          <div class="tab-pane fade" id="budget" role="tabpanel">
            <!-- Budget calculator content removed -->
          </div>

          <!-- Custom Inquiry Tab -->
          <div class="tab-pane fade" id="booking-form" role="tabpanel">
            <div class="row justify-content-center">
              <div class="col-lg-8">
                <div class="inquiry-card">
                  <h4 class="mb-4">
                    <i class="fas fa-envelope"></i> Custom Trip Inquiry
                  </h4>
                  <form action="{% url 'core:submit_inquiry' state.id %}" method="post">
                    {% csrf_token %}
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-user"></i> Your Name
                          </label>
                          <input type="text" name="name" class="form-control" placeholder="Enter your full name" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-envelope"></i> Email Address
                          </label>
                          <input type="email" name="email" class="form-control" placeholder="your.email@example.com" required>
                        </div>
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-phone"></i> Phone Number
                          </label>
                          <input type="tel" name="phone" class="form-control" placeholder="+91 98765 43210">
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-calendar"></i> Preferred Travel Dates
                          </label>
                          <input type="text" name="travel_dates" class="form-control" placeholder="e.g., Dec 15-20, 2024">
                        </div>
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-users"></i> Number of Travelers
                      </label>
                      <select name="travelers" class="form-select">
                        <option value="1">1 Person</option>
                        <option value="2" selected>2 People</option>
                        <option value="3">3 People</option>
                        <option value="4">4 People</option>
                        <option value="5+">5+ People</option>
                      </select>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-comment"></i> Trip Details
                      </label>
                      <textarea name="message" class="form-control" rows="4" 
                                placeholder="Tell us about your dream trip to {{ state.name }}... Include your interests, budget, and any specific requirements." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary-custom">
                      <i class="fas fa-paper-plane"></i> Send Inquiry
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Footer -->
  <footer class="footer py-4">
    <div class="container text-center">
      <p class="credit">Created by <span>Team South India Tourism</span> | ¬© 2025</p>
    </div>
  </footer>

  <!-- Back to Top Button -->
  <a href="#" class="back-to-top" aria-label="Back to Top">
    <i class="fas fa-chevron-up"></i>
  </a>

  <!-- Map Modal -->
  <div class="modal fade map-modal" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mapModalLabel">Location on Map</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="modalMapContainer" style="height: 500px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Places Map Modal -->
  <div class="modal fade" id="mainPlacesMapModal" tabindex="-1" aria-labelledby="mainPlacesMapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mainPlacesMapModalLabel">Location on Map</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="mainPlacesMap" style="height: 500px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Budget Calculator Modal - Removed -->

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  
  <!-- CSRF Token for AJAX requests -->
  <script>
    // Get CSRF token for AJAX requests
    function getCSRFToken() {
      const name = 'csrftoken';
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
  
  <script>
    // Navbar/Secondary Nav scroll effect for state pages
    window.addEventListener('scroll', function() {
      const navbar = document.querySelector('.navbar');
      const secondaryNav = document.querySelector('.secondary-nav');
      if (secondaryNav) {
        if (window.scrollY > 100) {
          navbar.style.display = 'none';
          secondaryNav.classList.add('active');
        } else {
          navbar.style.display = '';
          secondaryNav.classList.remove('active');
        }
      }
    });

    // Initialize AOS
    AOS.init({ duration: 1000, once: true });

    // Initialize maps for each place
    function initMaps() {
      {% for place_data in places_with_weather %}
      new google.maps.Map(document.getElementById('map-{{ place_data.place.id }}'), {
        center: { lat: {{ place_data.latitude }}, lng: {{ place_data.longitude }} },
        zoom: 15
      });
      {% endfor %}
    }

    // Load Google Maps API
    function loadGoogleMapsAPI() {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMaps`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    // Load the API when the page loads
    window.onload = loadGoogleMapsAPI;

    // Define the Gemini endpoint URL using Django's URL template tag
    const geminiRecommendationsUrl = "{% url 'core:get_gemini_recommendations' %}";

    // Add these new functions for map handling
    let recommendationMap = null;
    let currentMarker = null;
    let mainPlacesMap = null;
    let mainPlacesMarker = null;

    function showOnMap(latitude, longitude, placeName) {
      const mapModal = new bootstrap.Modal(document.getElementById('mapModal'));
      mapModal.show();
      if (!recommendationMap) {
        recommendationMap = new google.maps.Map(document.getElementById('modalMapContainer'), {
          center: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
          zoom: 15,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true
        });
      } else {
        recommendationMap.setCenter({ lat: parseFloat(latitude), lng: parseFloat(longitude) });
      }
      if (currentMarker) {
        currentMarker.setMap(null);
      }
      currentMarker = new google.maps.Marker({
        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        map: recommendationMap,
        title: placeName,
        animation: google.maps.Animation.DROP
      });
      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${placeName}</h6><p>Latitude: ${latitude}<br>Longitude: ${longitude}</p></div>`
      });
      currentMarker.addListener('click', () => {
        infoWindow.open(recommendationMap, currentMarker);
      });
      infoWindow.open(recommendationMap, currentMarker);
    }

    // Add this function to clear recommendations
    function clearRecommendations() {
        const geminiRecommendedPlacesDiv = document.getElementById("gemini-recommended-places");
        geminiRecommendedPlacesDiv.innerHTML = `
            <div class="text-center py-5">
                <div class="recommendation-placeholder">
                    <i class="fas fa-compass fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Ready to Discover?</h5>
                    <p class="text-muted">Select your preferences above and get personalized recommendations</p>
                </div>
            </div>
        `;
    }

    // Enhanced fetchGeminiRecommendations function
    function fetchGeminiRecommendations() {
        const placeSelect = document.getElementById("user-place");
        const selectedOption = placeSelect.options[placeSelect.selectedIndex];
        const userPlace = selectedOption.value;
        const latitude = selectedOption.getAttribute('data-lat');
        const longitude = selectedOption.getAttribute('data-lng');
        const placeType = document.getElementById("gemini-place-type").value;
        const budget = document.getElementById("budget").value;
        const duration = document.getElementById("duration").value;

        if (!latitude || !longitude) {
            alert("Please select a valid place");
            return;
        }

        const geminiRecommendedPlacesDiv = document.getElementById("gemini-recommended-places");
        geminiRecommendedPlacesDiv.innerHTML = `
            <div class="recommendation-loading">
                <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                <h5 class="mt-3 text-muted">Analyzing your preferences...</h5>
                <p class="text-muted">Finding the perfect places for you</p>
            </div>
        `;

        const url = `${geminiRecommendationsUrl}?latitude=${latitude}&longitude=${longitude}&user_place=${encodeURIComponent(userPlace)}&place_type=${placeType}&budget=${budget}&duration=${duration}&enhanced=true&context=karnataka`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    geminiRecommendedPlacesDiv.innerHTML = `<div class="alert alert-danger m-3"><i class="fas fa-exclamation-triangle"></i> Error: ${data.error}</div>`;
                    return;
                }

                const places = data.gemini_recommended_places;
                const weatherData = data.weather_data;

                if (!places || places.length === 0) {
                    geminiRecommendedPlacesDiv.innerHTML = `
                        <div class="alert alert-info m-3">
                            <i class="fas fa-info-circle"></i> No recommendations available at the moment.
                        </div>
                    `;
                    return;
                }

                // Display weather information with enhanced styling
                let html = `
                    <div class="recommendation-weather m-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-cloud-sun"></i> Current Weather
                                </h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Temperature:</strong> ${weatherData.temperature}¬∞C</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Weather:</strong> ${weatherData.weather}</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Humidity:</strong> ${weatherData.humidity}%</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Description:</strong> ${weatherData.description}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row m-3">
                `;

                places.forEach(place => {
                    const rating = place.rating || 'N/A';
                    const reasoning = place.reasoning || 'No description available';
                    
                    html += `
                        <div class="col-md-6 mb-4">
                            <div class="card recommendation-card">
                                <div class="card-body">
                                    <h5 class="card-title">${place.name}</h5>
                                    <span class="recommendation-badge">
                                        <i class="fas fa-star"></i> Rating: ${rating}
                                    </span>
                                    <div class="recommendation-weather">
                                        <h6><i class="fas fa-cloud"></i> Current Weather</h6>
                                        <p class="mb-1"><i class="fas fa-temperature-high"></i> ${weatherData.temperature}¬∞C</p>
                                        <p class="mb-1"><i class="fas fa-tint"></i> ${weatherData.humidity}% humidity</p>
                                        <p class="mb-0"><i class="fas fa-cloud-sun"></i> ${weatherData.weather}</p>
                                    </div>
                                    <p class="location-info">
                                        <i class="fas fa-map-marker-alt"></i> 
                                        ${parseFloat(place.latitude).toFixed(4)}, ${parseFloat(place.longitude).toFixed(4)}
                                    </p>
                                    <p class="reasoning">${reasoning}</p>
                                    <div class="recommendation-actions">
                                        <button class="btn btn-primary" 
                                                onclick="showOnMap(${place.latitude}, ${place.longitude}, '${place.name.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-map-marker-alt"></i> Show on Map
                                        </button>
                                        <button class="btn btn-outline-secondary" 
                                                onclick="addToFavorites('${place.name.replace(/'/g, "\\'")}', ${place.latitude}, ${place.longitude}, event)">
                                            <i class="far fa-heart"></i> Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += "</div>";
                geminiRecommendedPlacesDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                geminiRecommendedPlacesDiv.innerHTML = `<div class="alert alert-danger m-3"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
            });
    }

    // Function to add to favorites
    function addToFavorites(name, latitude, longitude, event) {
        const csrfToken = getCSRFToken();
        
        if (!csrfToken) {
            alert('CSRF token not found. Please refresh the page and try again.');
            return;
        }
        
        fetch('{% url "core:add_recommended_favorite" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                name: name,
                latitude: latitude,
                longitude: longitude
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const button = event.target;
                button.innerHTML = '<i class="fas fa-heart"></i> Added to Favorites';
                button.classList.add('favorited');
                button.disabled = true;
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${name} added to favorites!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            } else {
                alert('Error adding to favorites: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding to favorites: ' + error.message);
        });
    }

    // Function to show a place on the main places map
    function showMainPlaceOnMap(latitude, longitude, placeName) {
      // Show the modal
      const mapModal = new bootstrap.Modal(document.getElementById('mainPlacesMapModal'));
      mapModal.show();

      // Initialize map if not already done
      if (!mainPlacesMap) {
        mainPlacesMap = new google.maps.Map(document.getElementById('mainPlacesMap'), {
          center: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
          zoom: 15,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true
        });
      } else {
        mainPlacesMap.setCenter({ lat: parseFloat(latitude), lng: parseFloat(longitude) });
      }

      // Remove existing marker if any
      if (mainPlacesMarker) {
        mainPlacesMarker.setMap(null);
      }

      // Add new marker
      mainPlacesMarker = new google.maps.Marker({
        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        map: mainPlacesMap,
        title: placeName,
        animation: google.maps.Animation.DROP
      });

      // Add info window
      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${placeName}</h6><p>Latitude: ${latitude}<br>Longitude: ${longitude}</p></div>`
      });

      mainPlacesMarker.addListener('click', () => {
        infoWindow.open(mainPlacesMap, mainPlacesMarker);
      });

      // Open info window by default
      infoWindow.open(mainPlacesMap, mainPlacesMarker);
    }

    // Update the places list section
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize category filter on page load
      filterPlacesByCategory();
    });

    // Back to Top Button Functionality
    document.addEventListener('DOMContentLoaded', function() {
      const backToTopButton = document.querySelector('.back-to-top');
      
      window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
          backToTopButton.classList.add('show');
        } else {
          backToTopButton.classList.remove('show');
        }
      });

      backToTopButton.addEventListener('click', function(e) {
        e.preventDefault();
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    });

    // Global variables for map functionality
    let mainMap = null;
    let mapMarkers = [];
    let placesService = null;
    let geocoder = null;

    // Initialize the main map
    function initMainMap() {
      mainMap = new google.maps.Map(document.getElementById('mainMap'), {
        center: { lat: 12.9716, lng: 77.5946 }, // Bengaluru coordinates
        zoom: 10,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
      });

      placesService = new google.maps.places.PlacesService(mainMap);
      geocoder = new google.maps.Geocoder();

      // Add markers for existing places
      {% for place_data in places_with_weather %}
        addPlaceMarker({{ place_data.latitude }}, {{ place_data.longitude }}, '{{ place_data.place.name|escapejs }}', '{{ place_data.place.description|escapejs }}');
      {% endfor %}
    }

    // Function to show a place on the main map
    function showPlaceOnMap(latitude, longitude, placeName) {
      const position = { lat: parseFloat(latitude), lng: parseFloat(longitude) };
      
      // Center map on the place
      mainMap.setCenter(position);
      mainMap.setZoom(15);

      // Add a temporary marker
      const marker = new google.maps.Marker({
        position: position,
        map: mainMap,
        title: placeName,
        animation: google.maps.Animation.DROP
      });

      // Add info window
      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${placeName}</h6></div>`
      });

      marker.addListener('click', () => {
        infoWindow.open(mainMap, marker);
      });

      // Open info window by default
      infoWindow.open(mainMap, marker);

      // Remove marker after 5 seconds
      setTimeout(() => {
        marker.setMap(null);
      }, 5000);
    }

    // Function to add a permanent marker
    function addPlaceMarker(latitude, longitude, name, description) {
      const marker = new google.maps.Marker({
        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        map: mainMap,
        title: name
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${name}</h6><p>${description}</p></div>`
      });

      marker.addListener('click', () => {
        infoWindow.open(mainMap, marker);
      });

      mapMarkers.push(marker);
    }

    // Function to search nearby places
    function searchNearbyPlaces() {
      const searchLocation = document.getElementById('mapSearch').value;
      const placeType = document.getElementById('mapPlaceType').value;

      if (!searchLocation) {
        alert('Please enter a location to search');
        return;
      }

      // Geocode the search location
      geocoder.geocode({ address: searchLocation }, (results, status) => {
        if (status === 'OK') {
          const location = results[0].geometry.location;
          
          // Center map on search location
          mainMap.setCenter(location);
          mainMap.setZoom(14);

          // Search for nearby places
          const request = {
            location: location,
            radius: '5000',
            type: placeType
          };

          placesService.nearbySearch(request, (places, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              // Clear existing markers
              clearMapMarkers();

              // Add new markers
              places.forEach(place => {
                const marker = new google.maps.Marker({
                  position: place.geometry.location,
                  map: mainMap,
                  title: place.name
                });

                const infoWindow = new google.maps.InfoWindow({
                  content: `
                    <div class="p-2">
                      <h6>${place.name}</h6>
                      <p>${place.vicinity || place.formatted_address}</p>
                      ${place.rating ? `<p>Rating: ${place.rating} ‚≠ê</p>` : ''}
                    </div>
                  `
                });

                marker.addListener('click', () => {
                  infoWindow.open(mainMap, marker);
                });

                mapMarkers.push(marker);
              });
            } else {
              alert('No places found nearby');
            }
          });
        } else {
          alert('Location not found');
        }
      });
    }

    // Function to clear map markers
    function clearMapMarkers() {
      mapMarkers.forEach(marker => {
        marker.setMap(null);
      });
      mapMarkers = [];
    }

    // Client-side Category Filtering
    function filterPlacesByCategory() {
      const selectedCategory = document.getElementById('categoryFilter').value;
      const placeCards = document.querySelectorAll('.place-card-wrapper');
      
      placeCards.forEach(card => {
        const cardCategory = card.getAttribute('data-category').toLowerCase();
        
        // Enhanced category matching
        let shouldShow = false;
        
        if (selectedCategory === 'all') {
          shouldShow = true;
        } else {
          // Map filter categories to actual place categories
          const categoryMap = {
            'religious': ['religious', 'temple', 'church', 'mosque', 'gurudwara'],
            'natural': ['natural', 'beach', 'hill', 'mountain', 'forest', 'park', 'lake', 'waterfall'],
            'historical': ['historical', 'fort', 'palace', 'monument', 'museum', 'heritage'],
            'cultural': ['cultural', 'art', 'theater', 'gallery', 'festival'],
            'adventure': ['adventure', 'trek', 'climbing', 'rafting', 'wildlife', 'safari'],
            'entertainment': ['entertainment', 'amusement', 'shopping', 'restaurant', 'cafe']
          };
          
          const matchingCategories = categoryMap[selectedCategory] || [selectedCategory];
          shouldShow = matchingCategories.some(cat => cardCategory.includes(cat));
        }
        
        if (shouldShow) {
          card.style.display = 'block';
          card.classList.add('animate__animated', 'animate__fadeIn');
        } else {
          card.style.display = 'none';
        }
      });
      
      // Show message if no places found
      const visibleCards = document.querySelectorAll('.place-card-wrapper[style*="display: block"]');
      const noPlacesMessage = document.getElementById('no-places-message');
      
      if (visibleCards.length === 0) {
        if (!noPlacesMessage) {
          const messageDiv = document.createElement('div');
          messageDiv.id = 'no-places-message';
          messageDiv.className = 'col-12 text-center mt-4';
          messageDiv.innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> No places found for the selected category. Try selecting "All Categories" to see all available places.
            </div>
          `;
          document.getElementById('places-list').appendChild(messageDiv);
        }
      } else {
        if (noPlacesMessage) {
          noPlacesMessage.remove();
        }
      }
      
      // Update the count display
      updatePlaceCount(visibleCards.length);
    }
    
    // Function to update place count
    function updatePlaceCount(count) {
      const totalPlaces = document.querySelectorAll('.place-card-wrapper').length;
      const countDisplay = document.getElementById('place-count');
      
      if (!countDisplay) {
        const countDiv = document.createElement('div');
        countDiv.id = 'place-count';
        countDiv.className = 'text-center mb-3';
        countDiv.innerHTML = `<small class="text-muted">Showing ${count} of ${totalPlaces} places</small>`;
        document.getElementById('categoryFilter').parentNode.appendChild(countDiv);
      } else {
        countDisplay.innerHTML = `<small class="text-muted">Showing ${count} of ${totalPlaces} places</small>`;
      }
    }

    // Enhanced function to show a place on the main map
    function showPlaceOnMap(latitude, longitude, placeName) {
      // Show the modal
      const mapModal = new bootstrap.Modal(document.getElementById('mainPlacesMapModal'));
      mapModal.show();

      // Initialize map if not already done
      if (!mainPlacesMap) {
        mainPlacesMap = new google.maps.Map(document.getElementById('mainPlacesMap'), {
          center: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
          zoom: 15,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true
        });
      } else {
        mainPlacesMap.setCenter({ lat: parseFloat(latitude), lng: parseFloat(longitude) });
      }

      // Remove existing marker if any
      if (mainPlacesMarker) {
        mainPlacesMarker.setMap(null);
      }

      // Add new marker
      mainPlacesMarker = new google.maps.Marker({
        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        map: mainPlacesMap,
        title: placeName,
        animation: google.maps.Animation.DROP
      });

      // Add info window
      const infoWindow = new google.maps.InfoWindow({
        content: `<div class="p-2"><h6>${placeName}</h6><p>Latitude: ${latitude}<br>Longitude: ${longitude}</p></div>`
      });

      mainPlacesMarker.addListener('click', () => {
        infoWindow.open(mainPlacesMap, mainPlacesMarker);
      });

      // Open info window by default
      infoWindow.open(mainPlacesMap, mainPlacesMarker);
    }

    // Trip Planning JavaScript Functions
    
    // Enhanced AI-Powered Itinerary Generation
    function generateItinerary() {
      const duration = parseInt(document.getElementById('tripDuration').value);
      const style = document.getElementById('travelStyle').value;
      const startingPoint = document.getElementById('startingPoint').value;
      
      if (!startingPoint) {
        alert('Please enter a starting point');
        return;
      }
      
      // Show enhanced loading state
      const container = document.getElementById('itineraryDays');
      container.innerHTML = `
        <div class="itinerary-loading-container">
          <div class="loading-animation">
            <div class="loading-spinner">
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
            </div>
          </div>
          <div class="loading-content">
            <h4 class="loading-title">
              <i class="fas fa-magic"></i> Crafting Your Perfect Itinerary
            </h4>
            <div class="loading-steps">
              <div class="loading-step active">
                <i class="fas fa-search"></i>
                <span>Analyzing preferences...</span>
              </div>
              <div class="loading-step">
                <i class="fas fa-map-marked-alt"></i>
                <span>Optimizing routes...</span>
              </div>
              <div class="loading-step">
                <i class="fas fa-calendar-check"></i>
                <span>Building schedule...</span>
              </div>
            </div>
            <div class="loading-progress">
              <div class="progress-bar">
                <div class="progress-fill"></div>
              </div>
            </div>
          </div>
        </div>`;
      
      startLoadingAnimation();
      
      // Get places data from Django template
      const places = [
        {% for place_data in places_with_weather %}
          {
            id: {{ place_data.place.id }},
            name: '{{ place_data.place.name|escapejs }}',
            category: '{{ place_data.place.category|escapejs }}',
            description: '{{ place_data.place.description|escapejs }}',
            location: '{{ place_data.place.location|escapejs }}',
            latitude: {{ place_data.latitude }},
            longitude: {{ place_data.longitude }}
          }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
      
      // Determine starting coordinates
      const startingPlace = places.find(p => 
        p.name.toLowerCase().includes(startingPoint.toLowerCase()) || 
        startingPoint.toLowerCase().includes(p.name.toLowerCase())
      );
      const latitude = startingPlace ? startingPlace.latitude : 12.9716; // Default to Bengaluru
      const longitude = startingPlace ? startingPlace.longitude : 77.5946;
      
      generateAIItinerary(duration, style, startingPoint, places, latitude, longitude);
    }

    function generateAIItinerary(duration, style, startingPoint, places, latitude, longitude) {
      const url = `${geminiRecommendationsUrl}?latitude=${latitude}&longitude=${longitude}&user_place=${encodeURIComponent(startingPoint)}&place_type=tourist_attraction&budget=${style}&duration=${duration}&itinerary=true&travel_style=${style}&trip_duration=${duration}`;
      
      fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        const aiPlaces = data.gemini_recommended_places || [];
        const itineraryDays = createSmartItinerary(duration, style, startingPoint, places, aiPlaces);
        displayItinerary(itineraryDays, startingPoint);
      })
      .catch(error => {
        console.warn('AI recommendation failed, falling back to smart itinerary:', error);
        const itineraryDays = createSmartItinerary(duration, style, startingPoint, places, []);
        displayItinerary(itineraryDays, startingPoint);
      });
    }

    function createSmartItinerary(duration, style, startingPoint, places, aiPlaces) {
      const itineraryDays = [];
      const aiPlaceMap = new Map(aiPlaces.map(place => [place.name.toLowerCase(), {
        ...place,
        reasoning: place.reasoning || 'Recommended based on your preferences'
      }]));
      
      // Create a more diverse place selection strategy
      let allPlaces = [...places];
      
      // If we have AI recommendations, prioritize them but don't exclude others
      if (aiPlaces.length > 0) {
        const aiPlaceNames = new Set(aiPlaces.map(p => p.name.toLowerCase()));
        const aiMatchedPlaces = places.filter(p => aiPlaceNames.has(p.name.toLowerCase()));
        const otherPlaces = places.filter(p => !aiPlaceNames.has(p.name.toLowerCase()));
        
        // Mix AI recommendations with other places for variety
        allPlaces = [...aiMatchedPlaces, ...otherPlaces];
      }
      
      // Enhanced filtering with more variety
      let filteredPlaces = filterPlacesByStyle(allPlaces, style);
      
      // Ensure we have enough variety by including different categories
      const categories = ['temple', 'beach', 'hill', 'museum', 'park', 'fort', 'palace', 'garden', 'market', 'resort'];
      const categoryPlaces = {};
      
      // Group places by category
      categories.forEach(category => {
        categoryPlaces[category] = allPlaces.filter(p => 
          p.name.toLowerCase().includes(category) || 
          p.category.toLowerCase().includes(category)
        );
      });
      
      // If filtered places are too limited, add variety from other categories
      if (filteredPlaces.length < duration * 3) {
        const additionalPlaces = [];
        categories.forEach(category => {
          if (categoryPlaces[category].length > 0) {
            // Add 1-2 places from each category for variety
            const categorySample = categoryPlaces[category].slice(0, 2);
            additionalPlaces.push(...categorySample);
          }
        });
        
        // Remove duplicates and add to filtered places
        const uniqueAdditional = additionalPlaces.filter(p => 
          !filteredPlaces.some(fp => fp.id === p.id)
        );
        filteredPlaces = [...filteredPlaces, ...uniqueAdditional];
      }
      
      // Shuffle places for more variety
      filteredPlaces = shuffleArray(filteredPlaces);
      
      // Use diverse place selection for each day
      for (let day = 1; day <= duration; day++) {
        const dayPlaces = getDiversePlacesForDay(filteredPlaces, day, duration);
        
        if (dayPlaces.length > 0) {
          itineraryDays.push({
            day,
            places: dayPlaces,
            aiInsights: dayPlaces.map(place => aiPlaceMap.get(place.name.toLowerCase()) || null).filter(Boolean)
          });
        }
      }
      
      // If we still don't have enough days, add more places
      while (itineraryDays.length < duration) {
        const remainingPlaces = filteredPlaces.filter(p => 
          !itineraryDays.some(day => day.places.find(dp => dp.id === p.id))
        );
        
        if (remainingPlaces.length === 0) break;
        
        const dayPlaces = shuffleArray(remainingPlaces).slice(0, 2);
        itineraryDays.push({
          day: itineraryDays.length + 1,
          places: dayPlaces,
          aiInsights: []
        });
      }
      
      return itineraryDays;
    }

    // Helper function to shuffle array for variety
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function filterPlacesByStyle(places, style) {
      return places.filter(p => {
        const name = p.name.toLowerCase();
        const category = p.category.toLowerCase();
        
        switch (style) {
          case 'adventure':
            return ['adventure', 'park', 'hill', 'wildlife', 'forest', 'waterfall', 'trek', 'climbing'].some(c => 
              category.includes(c) || name.includes(c)
            );
          case 'cultural':
            return ['temple', 'museum', 'cultural', 'historical', 'fort', 'palace', 'heritage', 'monument'].some(c => 
              category.includes(c) || name.includes(c)
            );
          case 'relaxation':
            return ['beach', 'hill', 'garden', 'lake', 'resort', 'spa', 'wellness', 'meditation'].some(c => 
              category.includes(c) || name.includes(c)
            );
          case 'luxury':
            return ['resort', 'spa', 'hotel', 'palace', 'heritage', 'premium', 'exclusive'].some(c => 
              category.includes(c) || name.includes(c)
            );
          default:
            // For budget or any other style, include all places but prioritize variety
            return true;
        }
      });
    }

    function displayItinerary(itineraryDays, startingPoint) {
      const container = document.getElementById('itineraryDays');
      let html = itineraryDays.map(dayData => `
        <div class="itinerary-day">
          <h6><i class="fas fa-calendar-day"></i> Day ${dayData.day}</h6>
          ${dayData.day === 1 ? `<p class="text-muted mb-3"><i class="fas fa-map-marker-alt"></i> Starting from: ${startingPoint}</p>` : ''}
          ${dayData.places.map((place, index) => {
            const time = getTimeSlot(index, dayData.places.length);
            const aiInsight = dayData.aiInsights[index];
            return `
              <div class="itinerary-place">
                <span class="place-time">${time}</span>
                <div class="place-details">
                  <strong>${place.name}</strong>
                  <small class="text-muted d-block">${place.category}</small>
                  ${aiInsight ? `
                    <div class="ai-insight mt-2">
                      <i class="fas fa-robot text-primary"></i>
                      <small class="text-primary">AI Insight: ${aiInsight.reasoning}</small>
                    </div>` : ''}
                </div>
                <div class="place-actions">
                  <button class="btn btn-sm btn-outline-primary" onclick="showPlaceOnMap(${place.latitude || 0}, ${place.longitude || 0}, '${place.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-map-marker-alt"></i>
                  </button>
                </div>
              </div>
            `;
          }).join('')}
          ${dayData.aiInsights.length > 0 ? `
            <div class="day-summary mt-3 p-3 bg-light rounded">
              <h6><i class="fas fa-lightbulb text-warning"></i> AI Travel Tips for Day ${dayData.day}</h6>
              <ul class="mb-0">
                ${dayData.aiInsights.map(insight => `<li><small>${insight.reasoning}</small></li>`).join('')}
              </ul>
            </div>` : ''}
        </div>
      `).join('');
      
      container.innerHTML = html;
      document.getElementById('generatedItinerary').classList.remove('d-none');
    }

    // Helper functions
    function getTimeSlot(index, totalPlaces) {
      const startHour = 9; // 9 AM start
      const timePerPlace = Math.floor(8 / totalPlaces); // 8 hours available
      const hour = startHour + (index * timePerPlace);
      return `${hour}:00 - ${hour + timePerPlace}:00`;
    }

    function saveItinerary() {
      const itineraryData = {
        state: '{{ state.name }}',
        generatedAt: new Date().toISOString(),
        itinerary: document.getElementById('itineraryDays').innerHTML
      };
      localStorage.setItem('savedItinerary', JSON.stringify(itineraryData));
      alert('Itinerary saved successfully!');
    }

    function exportItinerary() {
      const itineraryContent = document.getElementById('itineraryDays').innerText;
      const blob = new Blob([itineraryContent], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '{{ state.name }}_itinerary.txt';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function resetItinerary() {
      document.getElementById('itineraryForm').reset();
      document.getElementById('generatedItinerary').classList.add('d-none');
    }

    // Enhanced Loading Animation Functions
    function startLoadingAnimation() {
      const steps = document.querySelectorAll('.loading-step');
      const progressFill = document.querySelector('.progress-fill');
      let currentStep = 0;
      
      function activateNextStep() {
        if (currentStep < steps.length) {
          if (currentStep > 0) steps[currentStep - 1].classList.remove('active');
          steps[currentStep].classList.add('active');
          progressFill.style.width = `${((currentStep + 1) / steps.length) * 100}%`;
          currentStep++;
          if (currentStep < steps.length) setTimeout(activateNextStep, 1000);
          else setTimeout(showLoadingSuccess, 500);
        }
      }
      
      setTimeout(activateNextStep, 500);
    }

    function showLoadingSuccess() {
      const container = document.getElementById('itineraryDays');
      container.innerHTML = `
        <div class="itinerary-loading-container">
          <div class="loading-animation">
            <div class="loading-success">
              <i class="fas fa-check-circle fa-3x text-success"></i>
            </div>
          </div>
          <div class="loading-content">
            <h4 class="loading-title text-success">
              <i class="fas fa-check-circle"></i> Itinerary Ready!
            </h4>
            <p class="text-muted">Your travel plan is prepared</p>
          </div>
        </div>`;
      
      setTimeout(() => {
        const duration = parseInt(document.getElementById('tripDuration').value);
        const style = document.getElementById('travelStyle').value;
        const startingPoint = document.getElementById('startingPoint').value;
        const places = [
          {% for place_data in places_with_weather %}
            {
              id: {{ place_data.place.id }},
              name: '{{ place_data.place.name|escapejs }}',
              category: '{{ place_data.place.category|escapejs }}',
              description: '{{ place_data.place.description|escapejs }}',
              location: '{{ place_data.place.location|escapejs }}',
              latitude: {{ place_data.latitude }},
              longitude: {{ place_data.longitude }}
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ];
        const itineraryDays = createSmartItinerary(duration, style, startingPoint, places, []);
        displayItinerary(itineraryDays, startingPoint);
      }, 1000);
    }
    
    // Review System
    let selectedRating = 0;
    
    // Star rating functionality
    document.addEventListener('DOMContentLoaded', function() {
      const stars = document.querySelectorAll('.star-rating');
      stars.forEach(star => {
        star.addEventListener('click', function() {
          const rating = parseInt(this.dataset.rating);
          selectedRating = rating;
          
          // Update star display
          stars.forEach((s, index) => {
            if (index < rating) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });
        });
        
        star.addEventListener('mouseenter', function() {
          const rating = parseInt(this.dataset.rating);
          stars.forEach((s, index) => {
            if (index < rating) {
              s.style.color = '#ffd700';
            }
          });
        });
        
        star.addEventListener('mouseleave', function() {
          stars.forEach((s, index) => {
            if (index < selectedRating) {
              s.style.color = '#ffd700';
            } else {
              s.style.color = '#dee2e6';
            }
          });
        });
      });
      
      // Add review form submission
      const addReviewForm = document.getElementById('addReviewForm');
      if (addReviewForm) {
        addReviewForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const placeId = document.getElementById('reviewPlace').value;
          const comment = document.getElementById('reviewComment').value;
          
          if (!placeId || !comment || selectedRating === 0) {
            alert('Please fill in all fields and select a rating');
            return;
          }
          
          // Submit review via AJAX
          submitReview(placeId, selectedRating, comment);
        });
      }
    });
    
    function submitReview(placeId, rating, comment) {
      const csrfToken = getCSRFToken();
      if (!csrfToken) {
        alert('CSRF token not found. Please refresh the page and try again.');
        return;
      }
      fetch('{% url "core:add_review" 0 %}'.replace('0', placeId), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `rating=${rating}&comment=${encodeURIComponent(comment)}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Review submitted!');
          window.location.reload();
          return;
        } else {
          alert('Error submitting review: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error submitting review: ' + error.message);
      });
    }
    
    function filterReviews(alwaysShowNew) {
      const ratingFilter = document.getElementById('reviewFilter').value;
      const placeFilter = document.getElementById('placeFilter').value;
      const reviewCards = document.querySelectorAll('.review-card');
      let visibleCount = 0;
      reviewCards.forEach(card => {
        const rating = parseInt(card.dataset.rating);
        const place = String(card.dataset.place); // Ensure string comparison
        let showCard = true;
        // Always show the newly added review at the top
        if (alwaysShowNew && card.hasAttribute('data-newly-added')) {
          card.style.display = 'block';
          visibleCount++;
          return;
        }
        if (ratingFilter !== 'all') {
          const minRating = parseInt(ratingFilter);
          if (rating < minRating) showCard = false;
        }
        if (placeFilter !== 'all' && place !== String(placeFilter)) showCard = false;
        card.style.display = showCard ? 'block' : 'none';
        if (showCard) visibleCount++;
      });
      // Show/hide the no reviews message
      let noMsg = document.getElementById('no-reviews-message');
      if (visibleCount === 0) {
        if (!noMsg) {
          noMsg = document.createElement('div');
          noMsg.id = 'no-reviews-message';
          noMsg.className = 'text-center py-4';
          noMsg.innerHTML = `
            <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
            <p class="text-muted">No reviews found for the selected filter.</p>
          `;
          document.getElementById('reviewsContainer').appendChild(noMsg);
        }
      } else {
        if (noMsg) noMsg.remove();
      }
    }
    
    // Budget Calculator - Removed

    // Budget Calculator Modal - Removed

    // Export Budget Results - Removed

    // Open Budget Calculator Modal - Removed

    // Enhanced Loading Animation Functions
    function startLoadingAnimation() {
      const steps = document.querySelectorAll('.loading-step');
      const progressFill = document.querySelector('.progress-fill');
      let currentStep = 0;
      
      // Function to activate next step
      function activateNextStep() {
        if (currentStep < steps.length) {
          // Deactivate previous step
          if (currentStep > 0) {
            steps[currentStep - 1].classList.remove('active');
          }
          
          // Activate current step
          steps[currentStep].classList.add('active');
          
          // Update progress bar
          const progress = ((currentStep + 1) / steps.length) * 100;
          progressFill.style.width = `${progress}%`;
          
          currentStep++;
          
          // Schedule next step
          if (currentStep < steps.length) {
            setTimeout(activateNextStep, 1500);
          } else {
            // Show success state after all steps complete
            setTimeout(showLoadingSuccess, 1000);
          }
        }
      }
      
      // Start the animation sequence
      setTimeout(activateNextStep, 500);
    }

    function updateLoadingStep(stepIndex, message) {
      const steps = document.querySelectorAll('.loading-step span');
      if (steps[stepIndex]) {
        steps[stepIndex].textContent = message;
      }
    }

    function showLoadingSuccess() {
      const container = document.getElementById('itineraryDays');
      container.innerHTML = `
        <div class="itinerary-loading-container">
          <div class="loading-animation">
            <div class="loading-success">
              <i class="fas fa-check-circle fa-3x text-success"></i>
            </div>
          </div>
          <div class="loading-content">
            <h4 class="loading-title text-success">
              <i class="fas fa-check-circle"></i> Itinerary Generated Successfully!
            </h4>
            <p class="text-muted">Your personalized travel plan is ready</p>
          </div>
        </div>
      `;
      
      // Show the generated itinerary after a brief delay
      setTimeout(() => {
        const duration = parseInt(document.getElementById('tripDuration').value);
        const style = document.getElementById('travelStyle').value;
        const startingPoint = document.getElementById('startingPoint').value;
        
        const places = [
          {% for place_data in places_with_weather %}
            {
              id: {{ place_data.place.id }},
              name: '{{ place_data.place.name|escapejs }}',
              category: '{{ place_data.place.category|escapejs }}',
              description: '{{ place_data.place.description|escapejs }}',
              location: '{{ place_data.place.location|escapejs }}',
              latitude: {{ place_data.latitude }},
              longitude: {{ place_data.longitude }}
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ];
        
        const itineraryDays = createSmartItinerary(duration, style, startingPoint, places, []);
        displayItinerary(itineraryDays, startingPoint);
      }, 2000);
    }

    // Helper function to shuffle array for variety
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Helper function to get diverse places for each day
    function getDiversePlacesForDay(places, dayNumber, totalDays) {
      const categories = ['temple', 'beach', 'hill', 'museum', 'park', 'fort', 'palace', 'garden', 'market', 'resort'];
      const dayPlaces = [];
      
      // Ensure each day has different types of places
      const categoryRotation = categories.slice((dayNumber - 1) % categories.length);
      
      categoryRotation.forEach(category => {
        const categoryPlaces = places.filter(p => 
          p.name.toLowerCase().includes(category) || 
          p.category.toLowerCase().includes(category)
        );
        
        if (categoryPlaces.length > 0) {
          // Add 1-2 places from this category
          const sample = shuffleArray(categoryPlaces).slice(0, 2);
          dayPlaces.push(...sample);
        }
      });
      
      // If we don't have enough places, add random ones
      if (dayPlaces.length < 2) {
        const remainingPlaces = places.filter(p => !dayPlaces.some(dp => dp.id === p.id));
        dayPlaces.push(...shuffleArray(remainingPlaces).slice(0, 2 - dayPlaces.length));
      }
      
      return shuffleArray(dayPlaces);
    }
  </script>
  <script src="{% static 'core/js/scripts.js' %}"></script>
  <script src="{% static 'core/js/state.js' %}"></script>
  <!-- Add a Bootstrap toast for review success -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="reviewSuccessToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-check-circle me-2"></i> Review added successfully!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>
  <!-- REMOVE all large <script> blocks with Tamil Nadu logic -->
  <script src="{% static 'core/js/karnataka.js' %}"></script>
</body>
</html>